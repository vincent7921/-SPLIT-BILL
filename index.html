<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ†å¸³ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f5f0e8; --surface:#fffdf8; --surface2:#f0ebe0;
    --ink:#1a1714; --ink2:#6b6560; --accent:#c84b2f;
    --green:#2d6a4f; --red:#c84b2f; --border:#ddd8cc;
    --shadow:0 2px 12px rgba(0,0,0,0.08); --radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;font-size:15px;line-height:1.6;}
  h1,h2,h3{font-family:'DM Serif Display',serif;font-weight:400;}

  /* Loading overlay */
  #loading-overlay{position:fixed;inset:0;background:rgba(245,240,232,0.92);display:none;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:12px;}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  #overlay-msg{font-size:14px;color:var(--ink2);}

  /* Setup */
  #setup-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
  .setup-card{background:var(--surface);border-radius:24px;padding:48px 40px;max-width:480px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,0.12);border:1px solid var(--border);}
  @media(max-width:520px){.setup-card{padding:32px 20px;}}
  .setup-card h1{font-size:2.2rem;margin-bottom:8px;color:var(--accent);}
  .setup-subtitle{color:var(--ink2);margin-bottom:32px;font-size:14px;}
  .form-group{margin-bottom:20px;}
  .form-group label{display:block;font-weight:600;font-size:13px;letter-spacing:0.04em;text-transform:uppercase;color:var(--ink2);margin-bottom:8px;}
  .form-group input{width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:10px;background:var(--bg);font-family:inherit;font-size:15px;color:var(--ink);outline:none;transition:border-color 0.2s;}
  .form-group input:focus{border-color:var(--accent);}
  .person-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
  .person-row{display:flex;gap:8px;align-items:center;}
  .person-row input{flex:1;}
  .btn-icon{width:40px;height:40px;border:none;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background 0.2s;flex-shrink:0;}
  .btn-remove{background:#fce8e4;color:var(--accent);}
  .btn-remove:hover{background:#f8d0c8;}
  .btn-add-person{background:none;border:1.5px dashed var(--border);border-radius:10px;padding:10px;width:100%;font-family:inherit;font-size:14px;color:var(--ink2);cursor:pointer;transition:all 0.2s;}
  .btn-add-person:hover{border-color:var(--accent);color:var(--accent);}
  .btn-primary{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:14px 28px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;width:100%;margin-top:8px;transition:background 0.2s,transform 0.1s;}
  .btn-primary:hover{background:#b03d24;}
  .btn-primary:disabled{opacity:0.6;cursor:not-allowed;}
  .setup-error{color:var(--red);font-size:13px;margin-bottom:10px;display:none;}

  /* Main */
  #main-screen{display:none;}
  .top-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;gap:12px;flex-wrap:wrap;}
  .top-bar h2{font-size:1.3rem;}
  .top-bar-right{display:flex;align-items:center;gap:12px;}
  .group-name-badge{font-size:12px;font-weight:600;background:var(--accent);color:#fff;padding:4px 12px;border-radius:20px;letter-spacing:0.03em;white-space:nowrap;}
  .sync-status{font-size:12px;padding:4px 10px;border-radius:20px;white-space:nowrap;}
  .sync-status.synced{background:#d8f3dc;color:var(--green);}
  .sync-status.saving{background:#fff3cd;color:#856404;}
  .sync-status.error{background:#fce8e4;color:var(--red);}

  /* Share bar */
  #share-bar{display:none;align-items:center;gap:10px;background:var(--surface);border-bottom:1px solid var(--border);padding:10px 24px;flex-wrap:wrap;}
  #share-bar label{font-size:12px;font-weight:600;color:var(--ink2);white-space:nowrap;}
  #share-url{flex:1;min-width:200px;padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;color:var(--ink);background:var(--bg);outline:none;}
  #copy-btn{padding:7px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:background 0.15s;}
  #copy-btn:hover{background:#b03d24;}

  .main-content{max-width:1100px;margin:0 auto;padding:24px;display:grid;grid-template-columns:390px 1fr;gap:24px;align-items:start;}
  @media(max-width:820px){.main-content{grid-template-columns:1fr;}}

  .card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;}
  .card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .card-header h3{font-size:1.05rem;}
  .section-icon{font-size:18px;margin-right:8px;}
  .card-body{padding:20px;}

  /* Form */
  .form-row{margin-bottom:16px;}
  .form-row-label{display:flex;align-items:center;justify-content:space-between;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;color:var(--ink2);margin-bottom:7px;}
  .form-row input[type=text],.form-row input[type=number],.form-row select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:9px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color 0.2s;}
  .form-row input:focus,.form-row select:focus{border-color:var(--accent);}
  .chip-group{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;min-height:48px;}
  .chip{display:inline-flex;align-items:center;padding:5px 14px;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;user-select:none;border:1.5px solid var(--border);background:var(--surface);color:var(--ink);transition:background 0.15s,border-color 0.15s,color 0.15s;}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .chip-link{font-size:11px;color:var(--ink2);background:none;border:none;cursor:pointer;text-decoration:underline;padding:0;font-family:inherit;}
  .chip-link:hover{color:var(--accent);}
  #custom-amounts{display:none;margin-top:10px;}
  .custom-amount-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
  .custom-amount-row .name-tag{min-width:60px;max-width:80px;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .custom-amount-row input{flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color 0.2s;}
  .custom-amount-row input:focus{border-color:var(--accent);}
  .unit-label{font-size:13px;color:var(--ink2);flex-shrink:0;}
  .custom-hint{font-size:12px;color:var(--ink2);margin-top:4px;min-height:18px;}
  .custom-hint.ok{color:var(--green);font-weight:600;}
  .custom-hint.bad{color:var(--red);font-weight:600;}
  .error-msg{color:var(--red);font-size:12px;margin-top:6px;display:none;}
  .btn-submit{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 20px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:4px;transition:background 0.2s;}
  .btn-submit:hover{background:#b03d24;}
  .btn-submit:disabled{opacity:0.6;cursor:not-allowed;}

  /* Right col */
  .right-col{display:flex;flex-direction:column;gap:20px;}
  .expense-item{border-bottom:1px solid var(--border);}
  .expense-item:last-child{border-bottom:none;}
  .expense-summary{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background 0.15s;}
  .expense-summary:hover{background:var(--bg);}
  .expense-title{font-weight:600;font-size:14px;}
  .expense-meta{font-size:12px;color:var(--ink2);margin-top:2px;}
  .expense-right{text-align:right;display:flex;align-items:center;gap:10px;flex-shrink:0;}
  .expense-amount{font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--accent);}
  .expand-icon{color:var(--ink2);font-size:11px;transition:transform 0.2s;}
  .expand-icon.open{transform:rotate(180deg);}
  .expense-detail{padding:0 20px 16px;display:none;}
  .expense-detail.open{display:block;}
  .split-row{display:flex;justify-content:space-between;padding:5px 0;font-size:13px;border-bottom:1px dashed var(--border);}
  .split-row:last-child{border-bottom:none;}
  .method-badge{font-size:10px;padding:2px 7px;border-radius:10px;background:var(--surface2);color:var(--ink2);margin-left:6px;white-space:nowrap;}
  .btn-delete{background:#fce8e4;color:var(--accent);border:none;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer;font-family:inherit;transition:background 0.15s;flex-shrink:0;}
  .btn-delete:hover{background:#f8d0c8;}
  .empty-state{padding:32px 20px;text-align:center;color:var(--ink2);font-size:14px;}
  .empty-state .icon{font-size:32px;margin-bottom:8px;}

  /* Ledger */
  .ledger-selector{padding:16px 20px;border-bottom:1px solid var(--border);}
  .ledger-selector select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:9px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;}
  .ledger-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
  .stat-box{padding:16px;background:var(--surface);text-align:center;}
  .stat-label{font-size:11px;text-transform:uppercase;letter-spacing:0.04em;color:var(--ink2);font-weight:600;}
  .stat-value{font-family:'DM Serif Display',serif;font-size:1.3rem;margin-top:4px;}
  .stat-value.positive{color:var(--green);}
  .stat-value.negative{color:var(--red);}
  .stat-value.zero{color:var(--ink2);}
  .ledger-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;margin:12px 16px;}
  .badge-receive{background:#d8f3dc;color:var(--green);}
  .badge-pay{background:#fce8e4;color:var(--red);}
  .badge-ok{background:var(--surface2);color:var(--ink2);}
  .ledger-breakdown{padding:0 20px 16px;}
  .ledger-breakdown h4{font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.04em;}
  .ledger-row{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px;}
  .ledger-row:last-child{border-bottom:none;}
  .ledger-row-left{flex:1;padding-right:12px;}
  .ledger-row-title{color:var(--ink);font-weight:500;}
  .ledger-row-meta{font-size:11px;color:var(--ink2);}
  .ledger-row-right{text-align:right;flex-shrink:0;}
  .impact-paid{color:var(--green);font-weight:600;}
  .impact-split{color:var(--red);}
  .impact-net{font-size:11px;color:var(--ink2);margin-top:2px;}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="overlay-msg">è¼‰å…¥ä¸­â€¦</div>
</div>

<!-- â•â• Setup â•â• -->
<div id="setup-screen">
  <div class="setup-card">
    <h1>åˆ†å¸³ç³»çµ±</h1>
    <p class="setup-subtitle">å»ºç«‹æ–°çš„åˆ†å¸³ç¾¤çµ„ï¼Œè³‡æ–™å³æ™‚é›²ç«¯åŒæ­¥</p>
    <div class="form-group">
      <label>åœ˜é«”åç¨±</label>
      <input type="text" id="group-name" placeholder="ä¾‹ï¼šå°åŒ—æ—…éŠåœ˜" maxlength="30">
    </div>
    <div class="form-group">
      <label>æˆå“¡åå–®</label>
      <div class="person-list" id="person-list"></div>
      <button class="btn-add-person" id="btn-add-person">ï¼‹ æ–°å¢æˆå“¡</button>
    </div>
    <div class="setup-error" id="setup-error"></div>
    <button class="btn-primary" id="start-btn">é–‹å§‹åˆ†å¸³ â†’</button>
  </div>
</div>

<!-- â•â• Main â•â• -->
<div id="main-screen">
  <div class="top-bar">
    <h2>åˆ†å¸³ç³»çµ±</h2>
    <div class="top-bar-right">
      <span class="sync-status synced" id="sync-status">âœ“ å·²åŒæ­¥</span>
      <span class="group-name-badge" id="top-group-name"></span>
    </div>
  </div>

  <!-- Share bar -->
  <div id="share-bar">
    <label>ğŸ”— åˆ†äº«é€£çµï¼ˆå…¶ä»–äººé–‹å•Ÿå³å¯åŠ å…¥åŒä¸€ç¾¤çµ„ï¼‰</label>
    <input type="text" id="share-url" readonly>
    <button id="copy-btn">è¤‡è£½é€£çµ</button>
  </div>

  <div class="main-content">
    <!-- Left: Add Expense -->
    <div>
      <div class="card">
        <div class="card-header"><h3><span class="section-icon">â•</span>æ–°å¢æ”¯å‡º</h3></div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-row-label">é …ç›®åç¨±</div>
            <input type="text" id="exp-title" placeholder="ä¾‹ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š">
          </div>
          <div class="form-row">
            <div class="form-row-label">é‡‘é¡ï¼ˆå…ƒï¼‰</div>
            <input type="number" id="exp-amount" placeholder="0" min="0" step="any">
          </div>
          <div class="form-row">
            <div class="form-row-label">ä»˜æ¬¾äºº</div>
            <select id="exp-payer"></select>
          </div>
          <div class="form-row">
            <div class="form-row-label">
              <span>åˆ†æ”¤å°è±¡</span>
              <span>
                <button class="chip-link" id="btn-select-all">å…¨é¸</button>
                &nbsp;Â·&nbsp;
                <button class="chip-link" id="btn-clear-all">æ¸…é™¤</button>
              </span>
            </div>
            <div class="chip-group" id="splitter-chips"></div>
          </div>
          <div class="form-row">
            <div class="form-row-label">åˆ†æ”¤æ–¹å¼</div>
            <select id="split-method">
              <option value="equal">å¹³å‡åˆ†æ”¤</option>
              <option value="custom">è‡ªè¨‚é‡‘é¡</option>
              <option value="percent">æŒ‰æ¯”ä¾‹ï¼ˆ%ï¼‰</option>
            </select>
          </div>
          <div id="custom-amounts">
            <div id="custom-inputs"></div>
            <div class="custom-hint" id="custom-hint"></div>
          </div>
          <div class="error-msg" id="form-error"></div>
          <button class="btn-submit" id="submit-btn">è¨˜éŒ„æ”¯å‡º</button>
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="right-col">
      <div class="card">
        <div class="card-header">
          <h3><span class="section-icon">ğŸ“‹</span>ç¸½å¸³æœ¬</h3>
          <span id="expense-count" style="font-size:13px;color:var(--ink2);"></span>
        </div>
        <div id="expense-list">
          <div class="empty-state"><div class="icon">ğŸ§¾</div>å°šç„¡æ”¯å‡ºè¨˜éŒ„</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3><span class="section-icon">ğŸ‘¤</span>è§’è‰²å¸³æœ¬</h3></div>
        <div class="ledger-selector">
          <select id="ledger-person"></select>
        </div>
        <div id="ledger-content"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Firebase v9 Modular SDK (CDN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
import { initializeApp }     from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc,
         addDoc, deleteDoc, getDoc,
         onSnapshot, query, orderBy,
         serverTimestamp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  â˜…  è«‹å°‡ä¸‹æ–¹æ›æˆæ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
const firebaseConfig = {
  apiKey:            "AIzaSyA0KO5nb4gqVT_ltca2B_-EVGD4s5qqyCI",
  authDomain:        "split-bill-9b60b.firebaseapp.com",
  projectId:         "split-bill-9b60b",
  storageBucket:     "split-bill-9b60b.firebasestorage.app",
  messagingSenderId: "223183892907",
  appId:             "1:223183892907:web:a271d3548d89630ec062ee"
};

// â”€â”€ Init Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ In-memory state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let groupId       = null;
let persons       = [];   // [{ id, name }]
let expenses      = [];   // [{ id, title, total, paidBy, splitMethod, splits }]
let unsubExpenses = null;

const METHOD_LABELS = { equal:'å¹³å‡åˆ†æ”¤', custom:'è‡ªè¨‚é‡‘é¡', percent:'æŒ‰æ¯”ä¾‹' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = n => (Math.round(n*100)/100).toLocaleString('zh-TW',{minimumFractionDigits:0,maximumFractionDigits:2});
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function showErr(el, msg){ el.textContent = msg; el.style.display = 'block'; }
function hideErr(el){ el.style.display = 'none'; }

function setSyncStatus(status){
  const el  = document.getElementById('sync-status');
  const map = { synced:['âœ“ å·²åŒæ­¥','synced'], saving:['â†‘ å„²å­˜ä¸­','saving'], error:['âœ• åŒæ­¥å¤±æ•—','error'] };
  const [text, cls] = map[status] || map.synced;
  el.textContent = text;
  el.className   = 'sync-status ' + cls;
}

function showOverlay(msg){
  document.getElementById('overlay-msg').textContent = msg || 'è¼‰å…¥ä¸­â€¦';
  document.getElementById('loading-overlay').style.display = 'flex';
}
function hideOverlay(){
  document.getElementById('loading-overlay').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Add initial two rows once DOM is ready
addPersonRow();
addPersonRow();

// Check URL for ?g=groupId â†’ auto-join
const urlParams = new URLSearchParams(location.search);
const gParam    = urlParams.get('g');
if(gParam) autoJoinGroup(gParam);

// â”€â”€ Button listeners for setup screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-add-person').addEventListener('click', addPersonRow);
document.getElementById('start-btn').addEventListener('click', startApp);

function addPersonRow(){
  const list = document.getElementById('person-list');
  const row  = document.createElement('div');
  row.className = 'person-row';

  const input = document.createElement('input');
  input.type        = 'text';
  input.placeholder = 'æˆå“¡åç¨±';
  input.maxLength   = 20;

  const btn = document.createElement('button');
  btn.type      = 'button';
  btn.className = 'btn-icon btn-remove';
  btn.title     = 'ç§»é™¤';
  btn.textContent = 'âœ•';
  btn.addEventListener('click', () => {
    if(document.getElementById('person-list').children.length > 1) row.remove();
  });

  row.appendChild(input);
  row.appendChild(btn);
  list.appendChild(row);
  input.focus();
}

async function autoJoinGroup(gid){
  showOverlay('è¼‰å…¥ç¾¤çµ„ä¸­â€¦');
  try {
    const snap = await getDoc(doc(db, 'groups', gid));
    if(!snap.exists()){ hideOverlay(); alert('æ‰¾ä¸åˆ°æ­¤åˆ†å¸³ç¾¤çµ„ï¼Œè«‹é‡æ–°å»ºç«‹ã€‚'); return; }
    groupId = gid;
    persons = snap.data().persons || [];
    enterMainScreen(snap.data().name);
  } catch(e){
    hideOverlay();
    alert('è¼‰å…¥ç¾¤çµ„å¤±æ•—ï¼š' + e.message);
  }
}

async function startApp(){
  const groupName = document.getElementById('group-name').value.trim();
  const inputs    = document.querySelectorAll('#person-list .person-row input');
  const names     = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
  const errEl     = document.getElementById('setup-error');
  hideErr(errEl);

  if(!groupName)                           { showErr(errEl,'è«‹è¼¸å…¥åœ˜é«”åç¨±'); return; }
  if(names.length < 1)                     { showErr(errEl,'è«‹è‡³å°‘æ–°å¢ä¸€ä½æˆå“¡'); return; }
  if(new Set(names).size !== names.length) { showErr(errEl,'æˆå“¡åç¨±ä¸å¯é‡è¤‡'); return; }

  const startBtn = document.getElementById('start-btn');
  startBtn.disabled    = true;
  startBtn.textContent = 'å»ºç«‹ä¸­â€¦';

  try {
    persons = names.map((n, i) => ({ id: 'p' + (i + 1), name: n }));
    const ref = await addDoc(collection(db, 'groups'), {
      name: groupName, persons, createdAt: serverTimestamp()
    });
    groupId = ref.id;
    enterMainScreen(groupName);
  } catch(e){
    showErr(errEl, 'Firebase é€£ç·šå¤±æ•—ï¼š' + e.message);
    startBtn.disabled    = false;
    startBtn.textContent = 'é–‹å§‹åˆ†å¸³ â†’';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterMainScreen(groupName){
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('main-screen').style.display  = 'block';
  document.getElementById('top-group-name').textContent = groupName;

  // Share bar
  const shareUrl = location.origin + location.pathname + '?g=' + groupId;
  document.getElementById('share-url').value          = shareUrl;
  document.getElementById('share-bar').style.display  = 'flex';

  buildFormControls();
  subscribeExpenses();
  hideOverlay();
}

// â”€â”€ Firestore real-time listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeExpenses(){
  if(unsubExpenses) unsubExpenses();
  const q = query(
    collection(db, 'groups', groupId, 'expenses'),
    orderBy('createdAt', 'asc')
  );
  unsubExpenses = onSnapshot(q, snap => {
    expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderExpenseList();
    renderLedger();
    setSyncStatus('synced');
  }, err => {
    console.error(err);
    setSyncStatus('error');
  });
}

// â”€â”€ Copy share link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('copy-btn').addEventListener('click', () => {
  const input = document.getElementById('share-url');
  input.select(); input.setSelectionRange(0, 9999);
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'å·²è¤‡è£½ï¼';
    setTimeout(() => btn.textContent = 'è¤‡è£½é€£çµ', 2000);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFormControls(){
  // Payer dropdown
  document.getElementById('exp-payer').innerHTML =
    persons.map(p => `<option value="${p.id}">${esc(p.name)}</option>`).join('');

  // Splitter chips
  buildSplitterChips();

  // Ledger person dropdown
  document.getElementById('ledger-person').innerHTML =
    persons.map(p => `<option value="${p.id}">${esc(p.name)}</option>`).join('');

  // Listeners (bind once after DOM elements exist)
  document.getElementById('btn-select-all').addEventListener('click', selectAllSplitters);
  document.getElementById('btn-clear-all').addEventListener('click', clearAllSplitters);
  document.getElementById('split-method').addEventListener('change', onSplitMethodChange);
  document.getElementById('exp-amount').addEventListener('input', onAmountInput);
  document.getElementById('submit-btn').addEventListener('click', addExpense);
  document.getElementById('ledger-person').addEventListener('change', renderLedger);
}

function buildSplitterChips(){
  const cg = document.getElementById('splitter-chips');
  cg.innerHTML = '';
  persons.forEach(p => {
    const chip       = document.createElement('button');
    chip.type        = 'button';
    chip.className   = 'chip active';
    chip.textContent = p.name;
    chip.dataset.pid = p.id;
    chip.addEventListener('click', function(){
      this.classList.toggle('active');
      refreshCustomInputs();
    });
    cg.appendChild(chip);
  });
}

function getActiveIds(){
  return Array.from(document.querySelectorAll('#splitter-chips .chip.active'))
              .map(c => c.dataset.pid);
}

function selectAllSplitters(){
  document.querySelectorAll('#splitter-chips .chip').forEach(c => c.classList.add('active'));
  refreshCustomInputs();
}
function clearAllSplitters(){
  document.querySelectorAll('#splitter-chips .chip').forEach(c => c.classList.remove('active'));
  refreshCustomInputs();
}

function onSplitMethodChange(){
  const method = document.getElementById('split-method').value;
  const box    = document.getElementById('custom-amounts');
  if(method === 'equal'){
    box.style.display = 'none';
  } else {
    box.style.display = 'block';
    rebuildCustomInputs();
  }
}

function onAmountInput(){
  if(document.getElementById('split-method').value !== 'equal') rebuildCustomInputs();
}

function refreshCustomInputs(){
  if(document.getElementById('split-method').value !== 'equal') rebuildCustomInputs();
}

function rebuildCustomInputs(){
  const ids    = getActiveIds();
  const method = document.getElementById('split-method').value;
  const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
  const container = document.getElementById('custom-inputs');
  container.innerHTML = '';
  if(ids.length === 0){ updateCustomHint(); return; }

  ids.forEach(pid => {
    const person = persons.find(p => p.id === pid);
    const defVal = method === 'percent'
      ? (100 / ids.length).toFixed(1)
      : (amount > 0 ? (amount / ids.length).toFixed(2) : '');

    const row = document.createElement('div');
    row.className = 'custom-amount-row';

    const nameSpan = document.createElement('span');
    nameSpan.className   = 'name-tag';
    nameSpan.textContent = person.name;

    const inp = document.createElement('input');
    inp.type        = 'number';
    inp.dataset.pid = pid;
    inp.min         = '0';
    inp.step        = 'any';
    inp.placeholder = method === 'percent' ? '%' : 'é‡‘é¡';
    inp.value       = defVal;
    inp.addEventListener('input', updateCustomHint);

    const unit = document.createElement('span');
    unit.className   = 'unit-label';
    unit.textContent = method === 'percent' ? '%' : 'å…ƒ';

    row.appendChild(nameSpan);
    row.appendChild(inp);
    row.appendChild(unit);
    container.appendChild(row);
  });
  updateCustomHint();
}

function updateCustomHint(){
  const method = document.getElementById('split-method').value;
  if(method === 'equal') return;
  const hint   = document.getElementById('custom-hint');
  const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
  const inputs = Array.from(document.querySelectorAll('#custom-inputs input[data-pid]'));
  const sum    = inputs.reduce((acc, i) => acc + (parseFloat(i.value) || 0), 0);

  if(method === 'custom'){
    if(sum === 0 && amount === 0){ hint.textContent = ''; hint.className = 'custom-hint'; return; }
    const diff = Math.round((amount - sum) * 100) / 100;
    if(Math.abs(diff) < 0.01){
      hint.textContent = `âœ“ åˆè¨ˆ $${fmt(sum)}ï¼Œèˆ‡ç¸½é¡ç›¸ç¬¦`;
      hint.className = 'custom-hint ok';
    } else {
      hint.textContent = `åˆè¨ˆ $${fmt(sum)} ï¼ ç¸½é¡ $${fmt(amount)}ï¼Œå·®é¡ $${fmt(diff)}`;
      hint.className = 'custom-hint bad';
    }
  } else {
    const diff = Math.round((100 - sum) * 10) / 10;
    if(Math.abs(diff) < 0.1){
      hint.textContent = `âœ“ åˆè¨ˆ ${sum.toFixed(1)}%`;
      hint.className = 'custom-hint ok';
    } else {
      hint.textContent = `åˆè¨ˆ ${sum.toFixed(1)}%ï¼Œéœ€é” 100%ï¼ˆå·® ${diff.toFixed(1)}%ï¼‰`;
      hint.className = 'custom-hint bad';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD EXPENSE â†’ Firestore
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addExpense(){
  const title   = document.getElementById('exp-title').value.trim();
  const amount  = parseFloat(document.getElementById('exp-amount').value);
  const payerId = document.getElementById('exp-payer').value;
  const method  = document.getElementById('split-method').value;
  const ids     = getActiveIds();
  const errEl   = document.getElementById('form-error');
  hideErr(errEl);

  // â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(!title)                 { showErr(errEl, 'è«‹è¼¸å…¥é …ç›®åç¨±'); return; }
  if(!amount || amount <= 0) { showErr(errEl, 'é‡‘é¡å¿…é ˆå¤§æ–¼ 0'); return; }
  if(ids.length === 0)       { showErr(errEl, 'è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡'); return; }

  // â”€â”€ Build splits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let splits = [];

  if(method === 'equal'){
    // å¹³å‡åˆ†æ”¤ï¼šæœ€å¾Œä¸€äººå¸æ”¶æ¨å…¥å·®
    const each = Math.floor((amount / ids.length) * 100) / 100;
    const last  = Math.round((amount - each * (ids.length - 1)) * 100) / 100;
    splits = ids.map((pid, i) => ({
      personId: pid,
      amount:   i === ids.length - 1 ? last : each
    }));

  } else if(method === 'custom'){
    // è‡ªè¨‚é‡‘é¡ï¼šé©—è­‰åˆè¨ˆ
    const inps = Array.from(document.querySelectorAll('#custom-inputs input[data-pid]'));
    let sum = 0;
    for(const inp of inps){
      const v = parseFloat(inp.value) || 0;
      if(v < 0){ showErr(errEl, 'åˆ†æ”¤é‡‘é¡ä¸å¯ç‚ºè² æ•¸'); return; }
      sum += v;
      splits.push({ personId: inp.dataset.pid, amount: Math.round(v * 100) / 100 });
    }
    if(Math.abs(sum - amount) > 0.01){
      showErr(errEl, `è‡ªè¨‚é‡‘é¡åˆè¨ˆ $${fmt(sum)}ï¼Œèˆ‡ç¸½é¡ $${fmt(amount)} ä¸ç¬¦ï¼Œè«‹èª¿æ•´`); return;
    }

  } else if(method === 'percent'){
    // æŒ‰æ¯”ä¾‹ï¼šé©—è­‰åˆè¨ˆ 100%ï¼Œæœ€å¾Œä¸€äººå¸æ”¶æ¨å…¥å·®
    const inps = Array.from(document.querySelectorAll('#custom-inputs input[data-pid]'));
    let pctSum = 0;
    const pcts = inps.map(inp => {
      const v = parseFloat(inp.value) || 0;
      pctSum += v;
      return { pid: inp.dataset.pid, pct: v };
    });
    if(Math.abs(pctSum - 100) > 0.1){
      showErr(errEl, `æ¯”ä¾‹åˆè¨ˆ ${pctSum.toFixed(1)}%ï¼Œéœ€ç­‰æ–¼ 100%`); return;
    }
    let assigned = 0;
    splits = pcts.map((item, i) => {
      let amt;
      if(i === pcts.length - 1){
        amt = Math.round((amount - assigned) * 100) / 100;
      } else {
        amt = Math.round((amount * item.pct / 100) * 100) / 100;
        assigned += amt;
      }
      return { personId: item.pid, amount: amt };
    });
  }

  // â”€â”€ Save to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const btn = document.getElementById('submit-btn');
  btn.disabled    = true;
  btn.textContent = 'å„²å­˜ä¸­â€¦';
  setSyncStatus('saving');

  try {
    await addDoc(collection(db, 'groups', groupId, 'expenses'), {
      title, total: amount, paidBy: payerId,
      splitMethod: method, splits,
      createdAt: serverTimestamp()
    });
    // Reset form
    document.getElementById('exp-title').value        = '';
    document.getElementById('exp-amount').value       = '';
    document.getElementById('split-method').value     = 'equal';
    document.getElementById('custom-amounts').style.display = 'none';
    document.getElementById('custom-inputs').innerHTML = '';
    document.getElementById('custom-hint').textContent = '';
    hideErr(errEl);
    selectAllSplitters();
    // onSnapshot will auto-update the list
  } catch(e){
    showErr(errEl, 'å„²å­˜å¤±æ•—ï¼š' + e.message);
    setSyncStatus('error');
  } finally {
    btn.disabled    = false;
    btn.textContent = 'è¨˜éŒ„æ”¯å‡º';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER EXPENSE LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExpenseList(){
  const container = document.getElementById('expense-list');
  const countEl   = document.getElementById('expense-count');
  countEl.textContent = expenses.length ? `å…± ${expenses.length} ç­†` : '';

  if(expenses.length === 0){
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ§¾</div>å°šç„¡æ”¯å‡ºè¨˜éŒ„</div>`;
    return;
  }

  // Show newest first (reverse without mutating)
  const reversed = expenses.slice().reverse();
  container.innerHTML = '';

  reversed.forEach(exp => {
    const payer     = persons.find(p => p.id === exp.paidBy);
    const payerName = payer ? payer.name : '?';
    const mLabel    = METHOD_LABELS[exp.splitMethod] || exp.splitMethod;
    const splits    = exp.splits || [];

    // â”€â”€ Outer item div â”€â”€
    const item = document.createElement('div');
    item.className = 'expense-item';

    // â”€â”€ Summary row â”€â”€
    const summary = document.createElement('div');
    summary.className = 'expense-summary';
    summary.innerHTML = `
      <div style="min-width:0;">
        <div class="expense-title">${esc(exp.title)}</div>
        <div class="expense-meta">${esc(payerName)} ä»˜æ¬¾ Â· ${splits.length} äºº <span class="method-badge">${mLabel}</span></div>
      </div>
      <div class="expense-right">
        <span class="expense-amount">$${fmt(exp.total)}</span>
        <button class="btn-delete" data-id="${exp.id}">åˆªé™¤</button>
        <span class="expand-icon">â–¼</span>
      </div>`;

    // â”€â”€ Detail block â”€â”€
    const detail = document.createElement('div');
    detail.className = 'expense-detail';
    detail.innerHTML = `<div style="font-size:12px;color:var(--ink2);margin-bottom:8px;">åˆ†æ”¤æ˜ç´°ï¼ˆ${mLabel}ï¼‰</div>` +
      splits.map(s => {
        const person = persons.find(p => p.id === s.personId);
        const extra  = exp.splitMethod === 'percent'
          ? ` <span style="color:var(--ink2);font-size:11px;">(${(s.amount/exp.total*100).toFixed(1)}%)</span>` : '';
        return `<div class="split-row">
          <span>${esc(person ? person.name : '?')}</span>
          <span><strong>$${fmt(s.amount)}</strong>${extra}</span>
        </div>`;
      }).join('');

    // Toggle expand
    summary.addEventListener('click', (e) => {
      // Don't toggle if delete button was clicked
      if(e.target.classList.contains('btn-delete')) return;
      detail.classList.toggle('open');
      summary.querySelector('.expand-icon').classList.toggle('open', detail.classList.contains('open'));
    });

    // Delete button
    summary.querySelector('.btn-delete').addEventListener('click', async (e) => {
      e.stopPropagation();
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
      setSyncStatus('saving');
      try {
        await deleteDoc(doc(db, 'groups', groupId, 'expenses', exp.id));
        // onSnapshot auto-updates
      } catch(err){
        alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
        setSyncStatus('error');
      }
    });

    item.appendChild(summary);
    item.appendChild(detail);
    container.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LEDGER  (computed entirely from expenses, never stored)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLedger(){
  const pid    = document.getElementById('ledger-person').value;
  const person = persons.find(p => p.id === pid);
  if(!person) return;

  let totalPaid = 0, totalSplit = 0;
  const rows = [];

  expenses.forEach(exp => {
    const paidByMe = exp.paidBy === pid;
    const myShare  = (exp.splits || []).find(s => s.personId === pid);
    if(!paidByMe && !myShare) return;

    const paid  = paidByMe ? exp.total       : 0;
    const split = myShare  ? myShare.amount  : 0;
    totalPaid  += paid;
    totalSplit += split;
    const payer = persons.find(p => p.id === exp.paidBy);
    rows.push({ exp, paid, split, net: paid - split, payerName: payer ? payer.name : '?' });
  });

  const balance = Math.round((totalPaid - totalSplit) * 100) / 100;
  const sc      = balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'zero';
  const label   = balance > 0 ? 'æ‡‰æ”¶æ¬¾'   : balance < 0 ? 'æ‡‰ä»˜æ¬¾'   : 'å·²å¹³è¡¡';
  const bc      = balance > 0 ? 'badge-receive' : balance < 0 ? 'badge-pay' : 'badge-ok';

  let html = `
    <div class="ledger-stats">
      <div class="stat-box"><div class="stat-label">å·²ä»˜ç¸½é¡</div><div class="stat-value">$${fmt(totalPaid)}</div></div>
      <div class="stat-box"><div class="stat-label">æ‡‰åˆ†æ”¤</div><div class="stat-value">$${fmt(totalSplit)}</div></div>
      <div class="stat-box"><div class="stat-label">å·®é¡</div><div class="stat-value ${sc}">${balance >= 0 ? '+' : ''}$${fmt(balance)}</div></div>
    </div>
    <span class="ledger-badge ${bc}">${label}ï¼š$${fmt(Math.abs(balance))}</span>
    <div class="ledger-breakdown">
      <h4>é€ç­†æ˜ç´°ï¼ˆå·®é¡ = å·²ä»˜ âˆ’ æ‡‰åˆ†æ”¤ï¼‰</h4>`;

  if(rows.length === 0){
    html += `<div style="color:var(--ink2);font-size:13px;padding:8px 0;">æ­¤è§’è‰²å°šç„¡ä»»ä½•æ”¯å‡ºç´€éŒ„</div>`;
  } else {
    rows.forEach(r => {
      const sign    = r.net >= 0 ? '+' : '';
      const pctNote = (r.exp.splitMethod === 'percent' && r.split > 0)
                      ? ` (${(r.split / r.exp.total * 100).toFixed(1)}%)` : '';
      html += `<div class="ledger-row">
        <div class="ledger-row-left">
          <div class="ledger-row-title">${esc(r.exp.title)}</div>
          <div class="ledger-row-meta">ä»˜æ¬¾äººï¼š${esc(r.payerName)} Â· ${METHOD_LABELS[r.exp.splitMethod] || ''}</div>
        </div>
        <div class="ledger-row-right">
          ${r.paid  > 0 ? `<div class="impact-paid">+$${fmt(r.paid)}ï¼ˆå·²ä»˜ï¼‰</div>` : ''}
          ${r.split > 0 ? `<div class="impact-split">âˆ’$${fmt(r.split)}ï¼ˆåˆ†æ”¤ï¼‰${esc(pctNote)}</div>` : ''}
          <div class="impact-net">å°è¨ˆ ${sign}$${fmt(r.net)}</div>
        </div>
      </div>`;
    });
  }
  html += `</div>`;
  document.getElementById('ledger-content').innerHTML = html;
}

</script>
</body>
</html>
