<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ†å¸³ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f0e8;--surface:#fffdf8;--surface2:#f0ebe0;
    --ink:#1a1714;--ink2:#6b6560;--accent:#c84b2f;
    --green:#2d6a4f;--red:#c84b2f;--border:#ddd8cc;
    --shadow:0 2px 12px rgba(0,0,0,0.08);--radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;font-size:15px;line-height:1.6;}
  h1,h2,h3,h4{font-family:'DM Serif Display',serif;font-weight:400;}

  /* Loading */
  #loading-overlay{position:fixed;inset:0;background:rgba(245,240,232,0.92);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:12px;}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  #overlay-msg{font-size:14px;color:var(--ink2);}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(26,23,20,0.45);display:none;align-items:center;justify-content:center;z-index:1500;padding:16px;}
  .modal-backdrop.open{display:flex;}
  .modal{background:var(--surface);border-radius:20px;padding:28px 24px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 12px 48px rgba(0,0,0,0.18);border:1px solid var(--border);}
  .modal h3{font-size:1.2rem;margin-bottom:4px;}
  .modal-subtitle{font-size:13px;color:var(--ink2);margin-bottom:20px;}
  .accordion-item{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden;}
  .accordion-header{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;cursor:pointer;background:var(--surface);transition:background .15s;user-select:none;}
  .accordion-header:hover{background:var(--bg);}
  .accordion-header-left{display:flex;align-items:center;gap:10px;}
  .accordion-icon{font-size:16px;}
  .accordion-title{font-size:14px;font-weight:600;color:var(--ink);}
  .accordion-arrow{font-size:11px;color:var(--ink2);transition:transform .2s;}
  .accordion-arrow.open{transform:rotate(180deg);}
  .accordion-body{display:none;padding:16px;border-top:1px solid var(--border);background:var(--bg);}
  .accordion-body.open{display:block;}
  .acc-row{margin-bottom:12px;}
  .acc-row label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink2);margin-bottom:5px;}
  .acc-row input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
  .acc-row input:focus{border-color:var(--accent);}
  .modal-error{color:var(--red);font-size:12px;margin-top:6px;display:none;}
  .modal-actions{display:flex;gap:10px;margin-top:16px;}
  .btn-modal-cancel{flex:1;background:var(--surface2);color:var(--ink2);border:none;border-radius:10px;padding:11px 18px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;}
  .btn-modal-cancel:hover{background:var(--border);}
  .modal-person-list{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
  .modal-person-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border-radius:8px;border:1px solid var(--border);font-size:14px;}
  .modal-person-item .p-name{flex:1;font-weight:500;}
  .btn-person-del{background:#fce8e4;color:var(--accent);border:none;border-radius:6px;padding:3px 9px;font-size:12px;cursor:pointer;font-family:inherit;transition:background .15s;white-space:nowrap;flex-shrink:0;}
  .btn-person-del:hover{background:#f8d0c8;}
  .modal-person-add-row{display:flex;gap:8px;}
  .modal-person-add-row input{flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
  .modal-person-add-row input:focus{border-color:var(--accent);}
  .btn-sm{padding:8px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;transition:background .2s;}
  .btn-sm:hover{background:#b03d24;}

  /* Setup */
  #setup-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
  .setup-card{background:var(--surface);border-radius:24px;padding:48px 40px;max-width:480px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.12);border:1px solid var(--border);}
  @media(max-width:520px){.setup-card{padding:32px 20px;}}
  .setup-card h1{font-size:2.2rem;margin-bottom:8px;color:var(--accent);}
  .setup-subtitle{color:var(--ink2);margin-bottom:32px;font-size:14px;}
  .form-group{margin-bottom:20px;}
  .form-group label{display:block;font-weight:600;font-size:13px;letter-spacing:.04em;text-transform:uppercase;color:var(--ink2);margin-bottom:8px;}
  .form-group input{width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:10px;background:var(--bg);font-family:inherit;font-size:15px;color:var(--ink);outline:none;transition:border-color .2s;}
  .form-group input:focus{border-color:var(--accent);}
  .person-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
  .person-row{display:flex;gap:8px;align-items:center;}
  .person-row input{flex:1;}
  .btn-icon{width:40px;height:40px;border:none;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0;}
  .btn-remove{background:#fce8e4;color:var(--accent);}
  .btn-remove:hover{background:#f8d0c8;}
  .btn-add-person{background:none;border:1.5px dashed var(--border);border-radius:10px;padding:10px;width:100%;font-family:inherit;font-size:14px;color:var(--ink2);cursor:pointer;transition:all .2s;}
  .btn-add-person:hover{border-color:var(--accent);color:var(--accent);}
  .btn-primary{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:14px 28px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;width:100%;margin-top:8px;transition:background .2s;}
  .btn-primary:hover{background:#b03d24;}
  .btn-primary:disabled{opacity:.6;cursor:not-allowed;}
  .setup-error{color:var(--red);font-size:13px;margin-bottom:10px;display:none;}
  .setup-divider{display:flex;align-items:center;gap:12px;margin:24px 0;color:var(--ink2);font-size:13px;}
  .setup-divider::before,.setup-divider::after{content:'';flex:1;height:1px;background:var(--border);}
  .btn-secondary{background:var(--surface2);color:var(--ink);border:1.5px solid var(--border);border-radius:12px;padding:13px 28px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;width:100%;transition:background .2s;}
  .btn-secondary:hover{background:var(--border);}

  /* Main */
  #main-screen{display:none;}
  .top-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;gap:12px;flex-wrap:wrap;}
  .top-bar h2{font-size:1.3rem;}
  .top-bar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .group-name-badge{font-size:12px;font-weight:600;background:var(--accent);color:#fff;padding:4px 12px;border-radius:20px;letter-spacing:.03em;white-space:nowrap;}
  .sync-status{font-size:12px;padding:4px 10px;border-radius:20px;white-space:nowrap;}
  .sync-status.synced{background:#d8f3dc;color:var(--green);}
  .sync-status.saving{background:#fff3cd;color:#856404;}
  .sync-status.error{background:#fce8e4;color:var(--red);}
  .btn-topbar{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;color:var(--ink2);transition:background .15s;white-space:nowrap;}
  .btn-topbar:hover{background:var(--border);color:var(--ink);}
  #share-bar{display:none;align-items:center;gap:10px;background:var(--surface);border-bottom:1px solid var(--border);padding:10px 24px;flex-wrap:wrap;}
  #share-bar label{font-size:12px;font-weight:600;color:var(--ink2);white-space:nowrap;}
  #share-url{flex:1;min-width:160px;padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;color:var(--ink);background:var(--bg);outline:none;}
  #copy-btn{padding:7px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:background .15s;}
  #copy-btn:hover{background:#b03d24;}

  .main-content{max-width:1100px;margin:0 auto;padding:24px;display:grid;grid-template-columns:390px 1fr;gap:24px;align-items:start;}
  @media(max-width:820px){.main-content{grid-template-columns:1fr;}}

  /* Collapsible Card */
  .card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;}
  .card-header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;transition:background .15s;}
  .card-header:hover{background:var(--surface2);}
  .card-header-left{display:flex;align-items:center;gap:4px;}
  .card-header h3{font-size:1.05rem;}
  .card-header-right{display:flex;align-items:center;gap:10px;}
  .card-meta{font-size:13px;color:var(--ink2);}
  .card-chevron{font-size:11px;color:var(--ink2);transition:transform .2s;}
  .card-chevron.open{transform:rotate(180deg);}
  .card-body{padding:20px;border-top:1px solid var(--border);}
  .card-body.collapsed{display:none;}
  .section-icon{font-size:16px;margin-right:6px;}

  /* Form */
  .form-row{margin-bottom:16px;}
  .form-row-label{display:flex;align-items:center;justify-content:space-between;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink2);margin-bottom:7px;}
  .form-row input[type=text],.form-row input[type=number],.form-row select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:9px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
  .form-row input:focus,.form-row select:focus{border-color:var(--accent);}
  .chip-group{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;min-height:48px;}
  .chip{display:inline-flex;align-items:center;padding:5px 14px;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;user-select:none;border:1.5px solid var(--border);background:var(--surface);color:var(--ink);transition:background .15s,border-color .15s,color .15s;}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .chip-link{font-size:11px;color:var(--ink2);background:none;border:none;cursor:pointer;text-decoration:underline;padding:0;font-family:inherit;}
  .chip-link:hover{color:var(--accent);}
  #custom-amounts{display:none;margin-top:10px;}
  .custom-amount-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
  .custom-amount-row .name-tag{min-width:52px;max-width:70px;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
  .custom-amount-row input{flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
  .custom-amount-row input:focus{border-color:var(--accent);}
  .unit-label{font-size:12px;color:var(--ink2);flex-shrink:0;}
  .custom-hint{font-size:12px;color:var(--ink2);margin-top:4px;min-height:18px;}
  .custom-hint.ok{color:var(--green);font-weight:600;}
  .custom-hint.bad{color:var(--red);font-weight:600;}
  .error-msg{color:var(--red);font-size:12px;margin-top:6px;display:none;}
  .btn-submit{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 20px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:4px;transition:background .2s;}
  .btn-submit:hover{background:#b03d24;}
  .btn-submit:disabled{opacity:.6;cursor:not-allowed;}

  /* Currency row */
  .currency-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
  .currency-rate-note{font-size:11px;color:var(--ink2);margin-top:4px;}
  .currency-rate-note.loading{color:var(--accent);}

  /* Multi-payer */
  #multi-payer-section{display:none;margin-top:6px;}
  .payer-amount-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
  .payer-amount-row .name-tag{min-width:52px;max-width:70px;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
  .payer-amount-row input{flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
  .payer-amount-row input:focus{border-color:var(--accent);}
  .payer-hint{font-size:12px;margin-top:4px;min-height:18px;}
  .payer-hint.ok{color:var(--green);font-weight:600;}
  .payer-hint.bad{color:var(--red);font-weight:600;}

  /* Right col */
  .right-col{display:flex;flex-direction:column;gap:16px;}

  /* Expense list */
  .expense-item{border-bottom:1px solid var(--border);}
  .expense-item:last-child{border-bottom:none;}
  .expense-summary{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .15s;}
  .expense-summary:hover{background:var(--bg);}
  .expense-title{font-weight:600;font-size:14px;}
  .expense-meta{font-size:12px;color:var(--ink2);margin-top:2px;}
  .expense-right{text-align:right;display:flex;align-items:center;gap:8px;flex-shrink:0;}
  .expense-amount{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--accent);}
  .expense-currency-tag{font-size:10px;padding:2px 6px;border-radius:8px;background:#e8f4fd;color:#1a6fa8;font-weight:600;white-space:nowrap;}
  .expand-icon{color:var(--ink2);font-size:11px;transition:transform .2s;}
  .expand-icon.open{transform:rotate(180deg);}
  .expense-detail{padding:0 20px 16px;display:none;}
  .expense-detail.open{display:block;}
  .split-row{display:flex;justify-content:space-between;padding:5px 0;font-size:13px;border-bottom:1px dashed var(--border);}
  .split-row:last-child{border-bottom:none;}
  .method-badge{font-size:10px;padding:2px 7px;border-radius:10px;background:var(--surface2);color:var(--ink2);margin-left:6px;white-space:nowrap;}
  .fx-note{font-size:11px;color:#1a6fa8;background:#e8f4fd;border-radius:8px;padding:6px 10px;margin-bottom:8px;}
  .btn-delete{background:#fce8e4;color:var(--accent);border:none;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer;font-family:inherit;transition:background .15s;flex-shrink:0;}
  .btn-delete:hover{background:#f8d0c8;}
  .empty-state{padding:32px 20px;text-align:center;color:var(--ink2);font-size:14px;}
  .empty-state .icon{font-size:32px;margin-bottom:8px;}

  /* Cleared */
  .expense-item.is-cleared .expense-title{text-decoration:line-through;color:var(--ink2);}
  .expense-item.is-cleared .expense-amount{color:var(--ink2);}
  .expense-item.is-cleared .expense-summary{opacity:.6;}
  .cleared-badge{font-size:10px;padding:2px 8px;border-radius:10px;background:#d8f3dc;color:var(--green);font-weight:600;white-space:nowrap;flex-shrink:0;}
  .btn-clear{border:none;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer;font-family:inherit;transition:background .15s;flex-shrink:0;white-space:nowrap;}
  .btn-clear.uncleared{background:var(--surface2);color:var(--ink2);}
  .btn-clear.uncleared:hover{background:var(--border);color:var(--green);}
  .btn-clear.cleared{background:#d8f3dc;color:var(--green);}
  .btn-clear.cleared:hover{background:#b7e4c7;}

  /* Ledger */
  .ledger-selector{padding:16px 20px 12px;}
  .ledger-selector select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:9px;background:var(--bg);font-family:inherit;font-size:14px;color:var(--ink);outline:none;}
  .ledger-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
  .stat-box{padding:14px;background:var(--surface);text-align:center;}
  .stat-label{font-size:11px;text-transform:uppercase;letter-spacing:.04em;color:var(--ink2);font-weight:600;}
  .stat-value{font-family:'DM Serif Display',serif;font-size:1.2rem;margin-top:2px;}
  .stat-value.positive{color:var(--green);}
  .stat-value.negative{color:var(--red);}
  .stat-value.zero{color:var(--ink2);}
  .ledger-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;margin:12px 16px 4px;}
  .badge-receive{background:#d8f3dc;color:var(--green);}
  .badge-pay{background:#fce8e4;color:var(--red);}
  .badge-ok{background:var(--surface2);color:var(--ink2);}
  .ledger-breakdown{padding:0 20px 16px;}
  .ledger-breakdown h4{font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.04em;margin-top:12px;}
  .ledger-row{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px;}
  .ledger-row:last-child{border-bottom:none;}
  .ledger-row-left{flex:1;padding-right:12px;}
  .ledger-row-title{color:var(--ink);font-weight:500;}
  .ledger-row-meta{font-size:11px;color:var(--ink2);}
  .ledger-fx-note{font-size:11px;color:#1a6fa8;margin-top:1px;}
  .ledger-cleared-note{font-size:11px;color:var(--green);margin-top:1px;}
  .ledger-row.is-cleared{opacity:.45;}
  .ledger-row.is-cleared .ledger-row-title{text-decoration:line-through;}
  .ledger-row-right{text-align:right;flex-shrink:0;}
  .impact-paid{color:var(--green);font-weight:600;}
  .impact-split{color:var(--red);}
  .impact-net{font-size:11px;color:var(--ink2);margin-top:2px;}

  /* Settlement */
  .settlement-body{padding:16px 20px;}
  .settlement-empty{color:var(--ink2);font-size:13px;text-align:center;padding:16px 0;}
  .settlement-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);font-size:14px;}
  .settlement-item:last-of-type{border-bottom:none;}
  .settlement-checkbox{width:18px;height:18px;accent-color:var(--green);cursor:pointer;flex-shrink:0;}
  .settlement-text{flex:1;}
  .settlement-text.done{color:var(--ink2);text-decoration:line-through;}
  .settlement-from{font-weight:600;}
  .settlement-arrow{color:var(--ink2);margin:0 4px;}
  .settlement-to{font-weight:600;}
  .settlement-amount{color:var(--accent);font-family:'DM Serif Display',serif;font-size:1.05rem;margin-left:auto;flex-shrink:0;}
  .settlement-amount.done{color:var(--ink2);}
  .settlement-footer{margin-top:12px;font-size:12px;color:var(--ink2);text-align:right;}
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="overlay-msg">è¼‰å…¥ä¸­â€¦</div>
</div>

<!-- â•â• Modal: ç®¡ç†ç¾¤çµ„ â•â• -->
<div class="modal-backdrop" id="modal-manage">
  <div class="modal">
    <h3>âš™ï¸ ç¾¤çµ„ç®¡ç†</h3>
    <p class="modal-subtitle" id="manage-current-group"></p>
    <div class="accordion-item">
      <div class="accordion-header" data-target="acc-members">
        <div class="accordion-header-left"><span class="accordion-icon">ğŸ‘¥</span><span class="accordion-title">æˆå“¡ç®¡ç†</span></div>
        <span class="accordion-arrow">â–¼</span>
      </div>
      <div class="accordion-body" id="acc-members">
        <div class="modal-person-list" id="manage-person-list"></div>
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink2);margin-bottom:5px;">æ–°å¢æˆå“¡</div>
        <div class="modal-person-add-row">
          <input type="text" id="manage-new-person" maxlength="20" placeholder="è¼¸å…¥æ–°æˆå“¡åç¨±">
          <button class="btn-sm" id="btn-add-member">æ–°å¢</button>
        </div>
        <div class="modal-error" id="manage-member-error"></div>
      </div>
    </div>
    <div class="accordion-item">
      <div class="accordion-header" data-target="acc-switch">
        <div class="accordion-header-left"><span class="accordion-icon">ğŸ”„</span><span class="accordion-title">åˆ‡æ›åˆ°æ—¢æœ‰ç¾¤çµ„</span></div>
        <span class="accordion-arrow">â–¼</span>
      </div>
      <div class="accordion-body" id="acc-switch">
        <div class="acc-row">
          <label>ç¾¤çµ„ ID æˆ–åˆ†äº«é€£çµ</label>
          <input type="text" id="manage-switch-id" placeholder="è²¼ä¸Šç¾¤çµ„ ID æˆ–å®Œæ•´é€£çµ">
        </div>
        <div class="modal-error" id="manage-switch-error"></div>
        <button class="btn-sm" id="btn-switch-group" style="width:100%;padding:10px;margin-top:4px;">åˆ‡æ›</button>
      </div>
    </div>
    <div class="accordion-item">
      <div class="accordion-header" data-target="acc-newgroup">
        <div class="accordion-header-left"><span class="accordion-icon">âœ¨</span><span class="accordion-title">å»ºç«‹æ–°ç¾¤çµ„</span></div>
        <span class="accordion-arrow">â–¼</span>
      </div>
      <div class="accordion-body" id="acc-newgroup">
        <p style="font-size:12px;color:var(--ink2);margin-bottom:12px;">å»ºç«‹å¾Œè‡ªå‹•åˆ‡æ›ï¼Œç›®å‰ç¾¤çµ„è³‡æ–™ä¸å—å½±éŸ¿ã€‚</p>
        <div class="acc-row">
          <label>ç¾¤çµ„åç¨±</label>
          <input type="text" id="new-group-name" maxlength="30" placeholder="è¼¸å…¥æ–°ç¾¤çµ„åç¨±">
        </div>
        <div class="acc-row">
          <label>æˆå“¡åå–®</label>
          <div id="new-group-persons" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
          <button class="btn-add-person" id="btn-new-group-add-person">ï¼‹ æ–°å¢æˆå“¡</button>
        </div>
        <div class="modal-error" id="manage-newgroup-error"></div>
        <button class="btn-sm" id="btn-create-new-group" style="width:100%;padding:10px;margin-top:8px;">å»ºç«‹ä¸¦åˆ‡æ›</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-modal-cancel" id="btn-manage-close">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- â•â• Modal: åŠ å…¥æ—¢æœ‰ç¾¤çµ„ â•â• -->
<div class="modal-backdrop" id="modal-join">
  <div class="modal">
    <h3>ğŸ”— åŠ å…¥æ—¢æœ‰ç¾¤çµ„</h3>
    <p class="modal-subtitle">è¼¸å…¥ç¾¤çµ„ ID æˆ–å®Œæ•´åˆ†äº«é€£çµ</p>
    <div class="acc-row">
      <label>ç¾¤çµ„ ID / é€£çµ</label>
      <input type="text" id="join-group-id" placeholder="ä¾‹ï¼šabc123xyz æˆ–å®Œæ•´ URL">
    </div>
    <div class="modal-error" id="join-error"></div>
    <div class="modal-actions">
      <button class="btn-modal-cancel" id="btn-join-cancel">å–æ¶ˆ</button>
      <button class="btn-sm" id="btn-join-confirm" style="flex:1;padding:11px 18px;border-radius:10px;">åŠ å…¥</button>
    </div>
  </div>
</div>

<!-- â•â• Setup â•â• -->
<div id="setup-screen">
  <div class="setup-card">
    <h1>åˆ†å¸³ç³»çµ±</h1>
    <p class="setup-subtitle">å»ºç«‹æ–°çš„åˆ†å¸³ç¾¤çµ„ï¼Œè³‡æ–™å³æ™‚é›²ç«¯åŒæ­¥</p>
    <div class="form-group">
      <label>åœ˜é«”åç¨±</label>
      <input type="text" id="group-name" placeholder="ä¾‹ï¼šå°åŒ—æ—…éŠåœ˜" maxlength="30">
    </div>
    <div class="form-group">
      <label>æˆå“¡åå–®</label>
      <div class="person-list" id="person-list"></div>
      <button class="btn-add-person" id="btn-add-person">ï¼‹ æ–°å¢æˆå“¡</button>
    </div>
    <div class="setup-error" id="setup-error"></div>
    <button class="btn-primary" id="start-btn">å»ºç«‹æ–°ç¾¤çµ„ â†’</button>
    <div class="setup-divider">æˆ–</div>
    <button class="btn-secondary" id="btn-open-join">åŠ å…¥æ—¢æœ‰ç¾¤çµ„</button>
  </div>
</div>

<!-- â•â• Main â•â• -->
<div id="main-screen">
  <div class="top-bar">
    <h2>åˆ†å¸³ç³»çµ±</h2>
    <div class="top-bar-right">
      <span class="sync-status synced" id="sync-status">âœ“ å·²åŒæ­¥</span>
      <span class="group-name-badge" id="top-group-name"></span>
      <button class="btn-topbar" id="btn-open-manage">âš™ï¸ ç®¡ç†ç¾¤çµ„</button>
    </div>
  </div>
  <div id="share-bar">
    <label>ğŸ”— åˆ†äº«é€£çµ</label>
    <input type="text" id="share-url" readonly>
    <button id="copy-btn">è¤‡è£½é€£çµ</button>
  </div>

  <div class="main-content">
    <div>
      <div class="card" id="card-add">
        <div class="card-header" id="hdr-add">
          <div class="card-header-left"><h3><span class="section-icon">â•</span>æ–°å¢æ”¯å‡º</h3></div>
          <div class="card-header-right"><span class="card-chevron open" id="chv-add">â–¼</span></div>
        </div>
        <div class="card-body" id="body-add">

          <!-- é …ç›®åç¨± -->
          <div class="form-row">
            <div class="form-row-label">é …ç›®åç¨±</div>
            <input type="text" id="exp-title" placeholder="ä¾‹ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š">
          </div>

          <!-- å¹£åˆ¥ + é‡‘é¡ -->
          <div class="currency-row">
            <div>
              <div class="form-row-label" style="margin-bottom:7px;">å¹£åˆ¥</div>
              <select id="exp-currency">
                <option value="TWD">TWD å°å¹£</option>
                <option value="USD">USD ç¾å…ƒ</option>
                <option value="JPY">JPY æ—¥åœ“</option>
                <option value="EUR">EUR æ­å…ƒ</option>
                <option value="KRW">KRW éŸ“å…ƒ</option>
                <option value="HKD">HKD æ¸¯å¹£</option>
                <option value="GBP">GBP è‹±éŠ</option>
                <option value="THB">THB æ³°éŠ–</option>
                <option value="AUD">AUD æ¾³å¹£</option>
                <option value="CNY">CNY äººæ°‘å¹£</option>
              </select>
            </div>
            <div>
              <div class="form-row-label" style="margin-bottom:7px;">åŸå§‹é‡‘é¡</div>
              <input type="number" id="exp-original-amount" placeholder="0" min="0" step="any">
            </div>
          </div>

          <!-- åŒ¯ç‡ (éTWDæ‰é¡¯ç¤º) -->
          <div id="rate-row" style="display:none;" class="form-row">
            <div class="form-row-label">
              <span>åŒ¯ç‡ï¼ˆ1 å¤–å¹£ = ? TWDï¼‰</span>
              <button class="chip-link" id="btn-refresh-rate">â†» é‡æ–°å–å¾—</button>
            </div>
            <input type="number" id="exp-rate" placeholder="åŒ¯ç‡" min="0" step="any">
            <div class="currency-rate-note" id="rate-note"></div>
          </div>

          <!-- æ›ç®—å¾Œå°å¹£ (éTWDæ‰é¡¯ç¤º) -->
          <div id="twd-row" style="display:none;" class="form-row">
            <div class="form-row-label">æ›ç®—å¾Œ TWD é‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
            <input type="number" id="exp-amount" placeholder="0" readonly style="background:var(--surface2);color:var(--ink2);">
          </div>
          <!-- TWDæ™‚ç›´æ¥ç”¨é€™å€‹ -->
          <div id="twd-direct-row" class="form-row">
            <div class="form-row-label">é‡‘é¡ï¼ˆTWDï¼‰</div>
            <input type="number" id="exp-amount-twd" placeholder="0" min="0" step="any">
          </div>

          <!-- ä»˜æ¬¾äºº -->
          <div class="form-row" id="single-payer-row">
            <div class="form-row-label">
              <span>ä»˜æ¬¾äºº</span>
              <button class="chip-link" id="btn-toggle-multi-payer">åˆ‡æ›å¤šäººä»˜æ¬¾</button>
            </div>
            <select id="exp-payer"></select>
          </div>

          <!-- å¤šä»˜æ¬¾äºº -->
          <div id="multi-payer-section">
            <div class="form-row-label" style="margin-bottom:8px;">
              <span style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink2);">å„äººä»˜æ¬¾é‡‘é¡</span>
              <button class="chip-link" id="btn-toggle-single-payer">åˆ‡æ›å–®äººä»˜æ¬¾</button>
            </div>
            <div id="payer-inputs"></div>
            <div class="payer-hint" id="payer-hint"></div>
          </div>

          <!-- åˆ†æ”¤å°è±¡ -->
          <div class="form-row">
            <div class="form-row-label">
              <span>åˆ†æ”¤å°è±¡</span>
              <span>
                <button class="chip-link" id="btn-select-all">å…¨é¸</button>
                &nbsp;Â·&nbsp;
                <button class="chip-link" id="btn-clear-all">æ¸…é™¤</button>
              </span>
            </div>
            <div class="chip-group" id="splitter-chips"></div>
          </div>

          <!-- åˆ†æ”¤æ–¹å¼ -->
          <div class="form-row">
            <div class="form-row-label">åˆ†æ”¤æ–¹å¼</div>
            <select id="split-method">
              <option value="equal">å¹³å‡åˆ†æ”¤</option>
              <option value="custom">è‡ªè¨‚é‡‘é¡ï¼ˆTWDï¼‰</option>
              <option value="percent">æŒ‰æ¯”ä¾‹ï¼ˆ%ï¼‰</option>
            </select>
          </div>
          <div id="custom-amounts">
            <div id="custom-inputs"></div>
            <div class="custom-hint" id="custom-hint"></div>
          </div>

          <div class="error-msg" id="form-error"></div>
          <button class="btn-submit" id="submit-btn">è¨˜éŒ„æ”¯å‡º</button>
        </div>
      </div>
    </div>

    <div class="right-col">
      <!-- ç¸½å¸³æœ¬ -->
      <div class="card" id="card-list">
        <div class="card-header" id="hdr-list">
          <div class="card-header-left"><h3><span class="section-icon">ğŸ“‹</span>ç¸½å¸³æœ¬</h3></div>
          <div class="card-header-right">
            <span class="card-meta" id="expense-count"></span>
            <span class="card-chevron open" id="chv-list">â–¼</span>
          </div>
        </div>
        <div class="card-body" id="body-list" style="padding:0;">
          <div id="expense-list"><div class="empty-state"><div class="icon">ğŸ§¾</div>å°šç„¡æ”¯å‡ºè¨˜éŒ„</div></div>
        </div>
      </div>

      <!-- è§’è‰²å¸³æœ¬ -->
      <div class="card" id="card-ledger">
        <div class="card-header" id="hdr-ledger">
          <div class="card-header-left"><h3><span class="section-icon">ğŸ‘¤</span>è§’è‰²å¸³æœ¬</h3></div>
          <div class="card-header-right"><span class="card-chevron" id="chv-ledger">â–¼</span></div>
        </div>
        <div class="card-body collapsed" id="body-ledger" style="padding:0;">
          <div class="ledger-selector"><select id="ledger-person"></select></div>
          <div id="ledger-content"></div>
        </div>
      </div>

      <!-- çµç®— -->
      <div class="card" id="card-settle">
        <div class="card-header" id="hdr-settle">
          <div class="card-header-left"><h3><span class="section-icon">ğŸ’°</span>çµç®—</h3></div>
          <div class="card-header-right"><span class="card-chevron" id="chv-settle">â–¼</span></div>
        </div>
        <div class="card-body collapsed" id="body-settle" style="padding:0;">
          <div class="settlement-body" id="settlement-content">
            <div class="settlement-empty">å°šç„¡è³‡æ–™</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc,
         addDoc, updateDoc, setDoc, deleteDoc, getDoc,
         onSnapshot, query, orderBy,
         serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  â˜…  è«‹å°‡ä¸‹æ–¹æ›æˆæ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
const firebaseConfig = {
  apiKey:            "AIzaSyA0KO5nb4gqVT_ltca2B_-EVGD4s5qqyCI",
  authDomain:        "split-bill-9b60b.firebaseapp.com",
  projectId:         "split-bill-9b60b",
  storageBucket:     "split-bill-9b60b.firebasestorage.app",
  messagingSenderId: "223183892907",
  appId:             "1:223183892907:web:a271d3548d89630ec062ee"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let groupId       = null;
let persons       = [];
let expenses      = [];
let settledIds    = new Set();
let unsubExpenses = null;
let unsubSettled  = null;
let isMultiPayer  = false;

const METHOD_LABELS = { equal:'å¹³å‡åˆ†æ”¤', custom:'è‡ªè¨‚é‡‘é¡', percent:'æŒ‰æ¯”ä¾‹' };
const CURRENCY_SYMBOLS = { TWD:'$',USD:'$',JPY:'Â¥',EUR:'â‚¬',KRW:'â‚©',HKD:'HK$',GBP:'Â£',THB:'à¸¿',AUD:'A$',CNY:'Â¥' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt    = n => (Math.round(n*100)/100).toLocaleString('zh-TW',{minimumFractionDigits:0,maximumFractionDigits:2});
const fmtFx  = n => (Math.round(n*10000)/10000).toLocaleString('zh-TW',{minimumFractionDigits:0,maximumFractionDigits:4});
const esc    = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const $      = id => document.getElementById(id);
const showErr  = (el,msg) => { el.textContent=msg; el.style.display='block'; };
const hideErr  = el => { el.style.display='none'; };
const setSyncStatus = s => {
  const el=$('sync-status'), map={synced:['âœ“ å·²åŒæ­¥','synced'],saving:['â†‘ å„²å­˜ä¸­','saving'],error:['âœ• åŒæ­¥å¤±æ•—','error']};
  const [t,c]=map[s]||map.synced; el.textContent=t; el.className='sync-status '+c;
};
const showOverlay = msg => { $('overlay-msg').textContent=msg||'è¼‰å…¥ä¸­â€¦'; $('loading-overlay').style.display='flex'; };
const hideOverlay = ()  => { $('loading-overlay').style.display='none'; };
const parseGroupId = raw => { raw=raw.trim(); try{ const u=new URL(raw); return u.searchParams.get('g')||''; }catch(e){ return raw; } };

// â”€â”€ Normalize expense: support old paidBy and new payers â”€â”€
function getPayers(exp){
  if(exp.payers && exp.payers.length) return exp.payers;
  return [{ personId: exp.paidBy, amount: exp.total }];
}

// â”€â”€ Current TWD amount (works for both modes) â”€â”€
function getTWD(exp){
  return exp.total; // always stored as TWD
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CURRENCY / FX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchRate(currency){
  if(currency === 'TWD') return 1;
  const noteEl = $('rate-note');
  noteEl.className='currency-rate-note loading'; noteEl.textContent='å–å¾—åŒ¯ç‡ä¸­â€¦';
  try{
    const res  = await fetch(`https://api.frankfurter.app/latest?from=${currency}&to=TWD`);
    const data = await res.json();
    const rate = data.rates && data.rates.TWD;
    if(!rate) throw new Error('ç„¡æ³•å–å¾—åŒ¯ç‡');
    noteEl.className='currency-rate-note';
    const dateStr = data.date || '';
    noteEl.textContent=`ä¾†æºï¼šFrankfurter Â· ${dateStr}`;
    return rate;
  }catch(e){
    noteEl.className='currency-rate-note'; noteEl.style.color='var(--red)';
    noteEl.textContent='åŒ¯ç‡å–å¾—å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥';
    return null;
  }
}

function onCurrencyChange(){
  const cur = $('exp-currency').value;
  const isTWD = cur === 'TWD';
  $('rate-row').style.display     = isTWD ? 'none' : 'block';
  $('twd-row').style.display      = isTWD ? 'none' : 'block';
  $('twd-direct-row').style.display = isTWD ? 'block' : 'none';
  if(!isTWD){
    fetchRate(cur).then(rate => {
      if(rate){ $('exp-rate').value = fmtFx(rate); recalcTWD(); }
    });
  }
}

function recalcTWD(){
  const orig = parseFloat($('exp-original-amount').value) || 0;
  const rate = parseFloat($('exp-rate').value) || 0;
  const twd  = Math.round(orig * rate * 100) / 100;
  $('exp-amount').value = twd || '';
  // Also update payer inputs if multi-payer
  if(isMultiPayer) updatePayerHint();
  if($('split-method').value !== 'equal') rebuildCustomInputs();
}

function getCurrentTWDAmount(){
  const cur = $('exp-currency').value;
  if(cur === 'TWD') return parseFloat($('exp-amount-twd').value) || 0;
  return parseFloat($('exp-amount').value) || 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
addPersonRow(); addPersonRow();
const urlGParam = new URLSearchParams(location.search).get('g');
if(urlGParam) autoJoinGroup(urlGParam);

$('btn-add-person').addEventListener('click', addPersonRow);
$('start-btn').addEventListener('click', startApp);
$('btn-open-join').addEventListener('click', () => openModal('modal-join'));

function addPersonRow(){
  const list=$('person-list');
  const row=document.createElement('div'); row.className='person-row';
  const input=document.createElement('input'); input.type='text'; input.placeholder='æˆå“¡åç¨±'; input.maxLength=20;
  const btn=document.createElement('button'); btn.type='button'; btn.className='btn-icon btn-remove'; btn.textContent='âœ•';
  btn.addEventListener('click',()=>{ if(list.children.length>1) row.remove(); });
  row.appendChild(input); row.appendChild(btn); list.appendChild(row); input.focus();
}

async function autoJoinGroup(gid){
  showOverlay('è¼‰å…¥ç¾¤çµ„ä¸­â€¦');
  try{
    const snap=await getDoc(doc(db,'groups',gid));
    if(!snap.exists()){ hideOverlay(); alert('æ‰¾ä¸åˆ°æ­¤åˆ†å¸³ç¾¤çµ„'); return; }
    groupId=gid; persons=snap.data().persons||[];
    enterMainScreen(snap.data().name);
  }catch(e){ hideOverlay(); alert('è¼‰å…¥ç¾¤çµ„å¤±æ•—ï¼š'+e.message); }
}

async function startApp(){
  const groupName=$('group-name').value.trim();
  const inputs=document.querySelectorAll('#person-list .person-row input');
  const names=Array.from(inputs).map(i=>i.value.trim()).filter(Boolean);
  const errEl=$('setup-error'); hideErr(errEl);
  if(!groupName){ showErr(errEl,'è«‹è¼¸å…¥åœ˜é«”åç¨±'); return; }
  if(names.length<1){ showErr(errEl,'è«‹è‡³å°‘æ–°å¢ä¸€ä½æˆå“¡'); return; }
  if(new Set(names).size!==names.length){ showErr(errEl,'æˆå“¡åç¨±ä¸å¯é‡è¤‡'); return; }
  const btn=$('start-btn'); btn.disabled=true; btn.textContent='å»ºç«‹ä¸­â€¦';
  try{
    persons=names.map((n,i)=>({id:'p'+(i+1),name:n}));
    const ref=await addDoc(collection(db,'groups'),{name:groupName,persons,createdAt:serverTimestamp()});
    groupId=ref.id; enterMainScreen(groupName);
  }catch(e){ showErr(errEl,'Firebase é€£ç·šå¤±æ•—ï¼š'+e.message); btn.disabled=false; btn.textContent='å»ºç«‹æ–°ç¾¤çµ„ â†’'; }
}

$('btn-join-cancel').addEventListener('click',()=>closeModal('modal-join'));
$('btn-join-confirm').addEventListener('click',async()=>{
  const raw=$('join-group-id').value.trim(); const errEl=$('join-error'); hideErr(errEl);
  if(!raw){ showErr(errEl,'è«‹è¼¸å…¥ç¾¤çµ„ ID æˆ–é€£çµ'); return; }
  const gid=parseGroupId(raw);
  if(!gid){ showErr(errEl,'ç„¡æ³•è§£æç¾¤çµ„ ID'); return; }
  const btn=$('btn-join-confirm'); btn.disabled=true; btn.textContent='è¼‰å…¥ä¸­â€¦';
  try{
    const snap=await getDoc(doc(db,'groups',gid));
    if(!snap.exists()){ showErr(errEl,'æ‰¾ä¸åˆ°æ­¤ç¾¤çµ„'); btn.disabled=false; btn.textContent='åŠ å…¥'; return; }
    groupId=gid; persons=snap.data().persons||[];
    closeModal('modal-join'); enterMainScreen(snap.data().name);
    history.replaceState(null,'','?g='+gid);
  }catch(e){ showErr(errEl,'è¼‰å…¥å¤±æ•—ï¼š'+e.message); }
  finally{ btn.disabled=false; btn.textContent='åŠ å…¥'; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTER MAIN SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterMainScreen(groupName){
  $('setup-screen').style.display='none';
  $('main-screen').style.display='block';
  $('top-group-name').textContent=groupName;
  $('share-url').value=location.origin+location.pathname+'?g='+groupId;
  $('share-bar').style.display='flex';
  initCardToggle('hdr-add','body-add','chv-add');
  initCardToggle('hdr-list','body-list','chv-list');
  initCardToggle('hdr-ledger','body-ledger','chv-ledger');
  initCardToggle('hdr-settle','body-settle','chv-settle');
  buildFormControls();
  subscribeExpenses();
  subscribeSettled();
  hideOverlay();
}

function initCardToggle(hdrId,bodyId,chvId){
  $(hdrId).addEventListener('click',()=>{
    const body=$(bodyId), chv=$(chvId);
    const isOpen=!body.classList.contains('collapsed');
    body.classList.toggle('collapsed',isOpen);
    chv.classList.toggle('open',!isOpen);
  });
}

function subscribeExpenses(){
  if(unsubExpenses) unsubExpenses();
  const q=query(collection(db,'groups',groupId,'expenses'),orderBy('createdAt','asc'));
  unsubExpenses=onSnapshot(q,snap=>{
    expenses=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderExpenseList(); renderLedger(); renderSettlement(); setSyncStatus('synced');
  },err=>{ console.error(err); setSyncStatus('error'); });
}

function subscribeSettled(){
  if(unsubSettled) unsubSettled();
  unsubSettled=onSnapshot(collection(db,'groups',groupId,'settled'),snap=>{
    settledIds=new Set(snap.docs.map(d=>d.id));
    renderSettlement();
  });
}

$('copy-btn').addEventListener('click',()=>{
  const inp=$('share-url'); inp.select(); inp.setSelectionRange(0,9999);
  navigator.clipboard.writeText(inp.value).then(()=>{
    const b=$('copy-btn'); b.textContent='å·²è¤‡è£½ï¼'; setTimeout(()=>b.textContent='è¤‡è£½é€£çµ',2000);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANAGE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('btn-open-manage').addEventListener('click', openManageModal);
$('btn-manage-close').addEventListener('click',()=>closeModal('modal-manage'));

document.querySelectorAll('.accordion-header').forEach(header=>{
  header.addEventListener('click',()=>{
    const targetId=header.dataset.target, body=$(targetId);
    if(!body) return;
    const arrow=header.querySelector('.accordion-arrow'), isOpen=body.classList.contains('open');
    document.querySelectorAll('.accordion-body').forEach(b=>b.classList.remove('open'));
    document.querySelectorAll('.accordion-arrow').forEach(a=>a.classList.remove('open'));
    if(!isOpen){ body.classList.add('open'); arrow.classList.add('open'); }
  });
});

function openManageModal(){
  $('manage-current-group').textContent='ç›®å‰ç¾¤çµ„ï¼š'+$('top-group-name').textContent;
  hideErr($('manage-member-error')); hideErr($('manage-switch-error')); hideErr($('manage-newgroup-error'));
  $('manage-switch-id').value=''; $('manage-new-person').value='';
  document.querySelectorAll('.accordion-body').forEach(b=>b.classList.remove('open'));
  document.querySelectorAll('.accordion-arrow').forEach(a=>a.classList.remove('open'));
  const c=$('new-group-persons'); c.innerHTML='';
  addNewGroupPersonRow(); addNewGroupPersonRow();
  $('new-group-name').value='';
  renderManagePersonList();
  openModal('modal-manage');
}

function renderManagePersonList(){
  const list=$('manage-person-list'); list.innerHTML='';
  if(!persons.length){ list.innerHTML='<div style="color:var(--ink2);font-size:13px;">å°šç„¡æˆå“¡</div>'; return; }
  persons.forEach(p=>{
    const item=document.createElement('div'); item.className='modal-person-item';
    const ns=document.createElement('span'); ns.className='p-name'; ns.textContent=p.name;
    const db2=document.createElement('button'); db2.className='btn-person-del'; db2.textContent='åˆªé™¤';
    db2.addEventListener('click',()=>deleteMember(p.id,p.name));
    item.appendChild(ns); item.appendChild(db2); list.appendChild(item);
  });
}

async function deleteMember(pid,pname){
  if(persons.length<=1){ alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½æˆå“¡'); return; }
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤æˆå“¡ã€Œ${pname}ã€å—ï¼Ÿ\nå·²è¨˜éŒ„çš„æ”¯å‡ºä¸å—å½±éŸ¿ã€‚`)) return;
  const errEl=$('manage-member-error'); hideErr(errEl);
  try{
    const up=persons.filter(p=>p.id!==pid);
    await updateDoc(doc(db,'groups',groupId),{persons:up});
    persons=up; renderManagePersonList(); rebuildFormPersons();
  }catch(e){ showErr(errEl,'åˆªé™¤å¤±æ•—ï¼š'+e.message); }
}

$('btn-add-member').addEventListener('click',async()=>{
  const name=$('manage-new-person').value.trim(); const errEl=$('manage-member-error'); hideErr(errEl);
  if(!name){ showErr(errEl,'è«‹è¼¸å…¥æˆå“¡åç¨±'); return; }
  if(persons.some(p=>p.name===name)){ showErr(errEl,'æ­¤æˆå“¡åç¨±å·²å­˜åœ¨'); return; }
  const nextNum=Math.max(0,...persons.map(p=>parseInt(p.id.replace('p',''))||0))+1;
  const np={id:'p'+nextNum,name};
  const btn=$('btn-add-member'); btn.disabled=true; btn.textContent='æ–°å¢ä¸­â€¦';
  try{
    const up=[...persons,np];
    await updateDoc(doc(db,'groups',groupId),{persons:up});
    persons=up; $('manage-new-person').value='';
    renderManagePersonList(); rebuildFormPersons();
    btn.textContent='âœ“ å·²æ–°å¢'; setTimeout(()=>{ btn.textContent='æ–°å¢'; btn.disabled=false; },1500);
  }catch(e){ showErr(errEl,'æ–°å¢å¤±æ•—ï¼š'+e.message); btn.disabled=false; btn.textContent='æ–°å¢'; }
});

$('btn-switch-group').addEventListener('click',async()=>{
  const raw=$('manage-switch-id').value.trim(); const errEl=$('manage-switch-error'); hideErr(errEl);
  if(!raw){ showErr(errEl,'è«‹è¼¸å…¥ç¾¤çµ„ ID æˆ–é€£çµ'); return; }
  const gid=parseGroupId(raw);
  if(!gid){ showErr(errEl,'ç„¡æ³•è§£æç¾¤çµ„ ID'); return; }
  if(gid===groupId){ showErr(errEl,'å·²ç¶“åœ¨æ­¤ç¾¤çµ„ä¸­'); return; }
  const btn=$('btn-switch-group'); btn.disabled=true; btn.textContent='åˆ‡æ›ä¸­â€¦';
  try{
    const snap=await getDoc(doc(db,'groups',gid));
    if(!snap.exists()){ showErr(errEl,'æ‰¾ä¸åˆ°æ­¤ç¾¤çµ„'); return; }
    if(unsubExpenses){ unsubExpenses(); unsubExpenses=null; }
    if(unsubSettled){ unsubSettled(); unsubSettled=null; }
    groupId=gid; persons=snap.data().persons||[]; expenses=[]; settledIds=new Set();
    $('top-group-name').textContent=snap.data().name;
    $('share-url').value=location.origin+location.pathname+'?g='+gid;
    history.replaceState(null,'','?g='+gid);
    closeModal('modal-manage'); buildFormControls(); subscribeExpenses(); subscribeSettled();
  }catch(e){ showErr(errEl,'åˆ‡æ›å¤±æ•—ï¼š'+e.message); }
  finally{ btn.disabled=false; btn.textContent='åˆ‡æ›'; }
});

function addNewGroupPersonRow(){
  const c=$('new-group-persons');
  const row=document.createElement('div'); row.className='person-row';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='æˆå“¡åç¨±'; inp.maxLength=20;
  const btn=document.createElement('button'); btn.type='button'; btn.className='btn-icon btn-remove'; btn.textContent='âœ•';
  btn.addEventListener('click',()=>{ if(c.children.length>1) row.remove(); });
  row.appendChild(inp); row.appendChild(btn); c.appendChild(row);
}
$('btn-new-group-add-person').addEventListener('click',addNewGroupPersonRow);

$('btn-create-new-group').addEventListener('click',async()=>{
  const newName=$('new-group-name').value.trim();
  const names=Array.from(document.querySelectorAll('#new-group-persons .person-row input')).map(i=>i.value.trim()).filter(Boolean);
  const errEl=$('manage-newgroup-error'); hideErr(errEl);
  if(!newName){ showErr(errEl,'è«‹è¼¸å…¥æ–°ç¾¤çµ„åç¨±'); return; }
  if(!names.length){ showErr(errEl,'è«‹è‡³å°‘æ–°å¢ä¸€ä½æˆå“¡'); return; }
  if(new Set(names).size!==names.length){ showErr(errEl,'æˆå“¡åç¨±ä¸å¯é‡è¤‡'); return; }
  const btn=$('btn-create-new-group'); btn.disabled=true; btn.textContent='å»ºç«‹ä¸­â€¦';
  try{
    const np=names.map((n,i)=>({id:'p'+(i+1),name:n}));
    const ref=await addDoc(collection(db,'groups'),{name:newName,persons:np,createdAt:serverTimestamp()});
    if(unsubExpenses){ unsubExpenses(); unsubExpenses=null; }
    if(unsubSettled){ unsubSettled(); unsubSettled=null; }
    groupId=ref.id; persons=np; expenses=[]; settledIds=new Set();
    $('top-group-name').textContent=newName;
    $('share-url').value=location.origin+location.pathname+'?g='+ref.id;
    history.replaceState(null,'','?g='+ref.id);
    closeModal('modal-manage'); buildFormControls(); subscribeExpenses(); subscribeSettled();
  }catch(e){ showErr(errEl,'å»ºç«‹å¤±æ•—ï¼š'+e.message); }
  finally{ btn.disabled=false; btn.textContent='å»ºç«‹ä¸¦åˆ‡æ›'; }
});

function rebuildFormPersons(){
  $('exp-payer').innerHTML=persons.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  buildSplitterChips(); buildPayerInputs();
  $('ledger-person').innerHTML=persons.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  renderLedger(); renderSettlement();
}

function openModal(id){ $(id).classList.add('open'); }
function closeModal(id){ $(id).classList.remove('open'); }
document.querySelectorAll('.modal-backdrop').forEach(bd=>{
  bd.addEventListener('click',e=>{ if(e.target===bd) bd.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFormControls(){
  $('exp-payer').innerHTML=persons.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  buildSplitterChips();
  buildPayerInputs();
  $('ledger-person').innerHTML=persons.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');

  // Currency
  $('exp-currency').addEventListener('change', onCurrencyChange);
  $('exp-original-amount').addEventListener('input', recalcTWD);
  $('exp-rate').addEventListener('input', recalcTWD);
  $('btn-refresh-rate').addEventListener('click', ()=>{
    const cur=$('exp-currency').value;
    if(cur!=='TWD') fetchRate(cur).then(r=>{ if(r){ $('exp-rate').value=fmtFx(r); recalcTWD(); } });
  });
  $('exp-amount-twd').addEventListener('input',()=>{
    if($('split-method').value!=='equal') rebuildCustomInputs();
    if(isMultiPayer) updatePayerHint();
  });

  // Multi-payer toggle
  $('btn-toggle-multi-payer').addEventListener('click', ()=>setMultiPayer(true));
  $('btn-toggle-single-payer').addEventListener('click', ()=>setMultiPayer(false));

  $('btn-select-all').addEventListener('click', selectAllSplitters);
  $('btn-clear-all').addEventListener('click', clearAllSplitters);
  $('split-method').addEventListener('change', onSplitMethodChange);
  $('submit-btn').addEventListener('click', addExpense);
  $('ledger-person').addEventListener('change', renderLedger);
}

// â”€â”€ Multi-payer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMultiPayer(multi){
  isMultiPayer=multi;
  $('single-payer-row').style.display = multi ? 'none' : 'block';
  $('multi-payer-section').style.display = multi ? 'block' : 'none';
  if(multi) updatePayerHint();
}

function buildPayerInputs(){
  const c=$('payer-inputs'); c.innerHTML='';
  persons.forEach(p=>{
    const row=document.createElement('div'); row.className='payer-amount-row';
    const ns=document.createElement('span'); ns.className='name-tag'; ns.textContent=p.name;
    const inp=document.createElement('input'); inp.type='number'; inp.dataset.pid=p.id;
    inp.min='0'; inp.step='any'; inp.placeholder='0';
    inp.addEventListener('input', updatePayerHint);
    const ul=document.createElement('span'); ul.className='unit-label'; ul.textContent='TWD';
    row.appendChild(ns); row.appendChild(inp); row.appendChild(ul);
    c.appendChild(row);
  });
}

function updatePayerHint(){
  const total=getCurrentTWDAmount();
  const sum=Array.from(document.querySelectorAll('#payer-inputs input[data-pid]'))
    .reduce((acc,i)=>acc+(parseFloat(i.value)||0),0);
  const hint=$('payer-hint');
  if(!total && !sum){ hint.textContent=''; hint.className='payer-hint'; return; }
  const diff=Math.round((total-sum)*100)/100;
  if(Math.abs(diff)<0.01){ hint.textContent=`âœ“ åˆè¨ˆ $${fmt(sum)} TWDï¼Œèˆ‡ç¸½é¡ç›¸ç¬¦`; hint.className='payer-hint ok'; }
  else { hint.textContent=`ä»˜æ¬¾åˆè¨ˆ $${fmt(sum)} / ç¸½é¡ $${fmt(total)} TWDï¼Œå·®é¡ $${fmt(diff)}`; hint.className='payer-hint bad'; }
}

// â”€â”€ Splitter chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSplitterChips(){
  const cg=$('splitter-chips'); cg.innerHTML='';
  persons.forEach(p=>{
    const chip=document.createElement('button');
    chip.type='button'; chip.className='chip active'; chip.textContent=p.name; chip.dataset.pid=p.id;
    chip.addEventListener('click',function(){ this.classList.toggle('active'); refreshCustomInputs(); });
    cg.appendChild(chip);
  });
}
function getActiveIds(){ return Array.from(document.querySelectorAll('#splitter-chips .chip.active')).map(c=>c.dataset.pid); }
function selectAllSplitters(){ document.querySelectorAll('#splitter-chips .chip').forEach(c=>c.classList.add('active')); refreshCustomInputs(); }
function clearAllSplitters(){ document.querySelectorAll('#splitter-chips .chip').forEach(c=>c.classList.remove('active')); refreshCustomInputs(); }

function onSplitMethodChange(){
  const method=$('split-method').value, box=$('custom-amounts');
  if(method==='equal'){ box.style.display='none'; } else { box.style.display='block'; rebuildCustomInputs(); }
}
function refreshCustomInputs(){ if($('split-method').value!=='equal') rebuildCustomInputs(); }

function rebuildCustomInputs(){
  const ids=getActiveIds(), method=$('split-method').value, amount=getCurrentTWDAmount();
  const c=$('custom-inputs'); c.innerHTML='';
  if(!ids.length){ updateCustomHint(); return; }
  ids.forEach(pid=>{
    const person=persons.find(p=>p.id===pid);
    const defVal=method==='percent'?(100/ids.length).toFixed(1):(amount>0?(amount/ids.length).toFixed(2):'');
    const row=document.createElement('div'); row.className='custom-amount-row';
    const ns=document.createElement('span'); ns.className='name-tag'; ns.textContent=person.name;
    const inp=document.createElement('input'); inp.type='number'; inp.dataset.pid=pid; inp.min='0'; inp.step='any';
    inp.placeholder=method==='percent'?'%':'é‡‘é¡'; inp.value=defVal;
    inp.addEventListener('input',updateCustomHint);
    const ul=document.createElement('span'); ul.className='unit-label'; ul.textContent=method==='percent'?'%':'TWD';
    row.appendChild(ns); row.appendChild(inp); row.appendChild(ul); c.appendChild(row);
  });
  updateCustomHint();
}

function updateCustomHint(){
  const method=$('split-method').value; if(method==='equal') return;
  const hint=$('custom-hint'), amount=getCurrentTWDAmount();
  const sum=Array.from(document.querySelectorAll('#custom-inputs input[data-pid]')).reduce((acc,i)=>acc+(parseFloat(i.value)||0),0);
  if(method==='custom'){
    if(!sum&&!amount){ hint.textContent=''; hint.className='custom-hint'; return; }
    const diff=Math.round((amount-sum)*100)/100;
    if(Math.abs(diff)<0.01){ hint.textContent=`âœ“ åˆè¨ˆ $${fmt(sum)} TWD`; hint.className='custom-hint ok'; }
    else { hint.textContent=`åˆè¨ˆ $${fmt(sum)} / ç¸½é¡ $${fmt(amount)} TWDï¼Œå·® $${fmt(diff)}`; hint.className='custom-hint bad'; }
  } else {
    const diff=Math.round((100-sum)*10)/10;
    if(Math.abs(diff)<0.1){ hint.textContent=`âœ“ åˆè¨ˆ ${sum.toFixed(1)}%`; hint.className='custom-hint ok'; }
    else { hint.textContent=`åˆè¨ˆ ${sum.toFixed(1)}%ï¼Œéœ€é” 100%ï¼ˆå·® ${diff.toFixed(1)}%ï¼‰`; hint.className='custom-hint bad'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD EXPENSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addExpense(){
  const title=$('exp-title').value.trim();
  const currency=$('exp-currency').value;
  const originalAmount = currency==='TWD' ? 0 : (parseFloat($('exp-original-amount').value)||0);
  const rate = currency==='TWD' ? 1 : (parseFloat($('exp-rate').value)||0);
  const amount = getCurrentTWDAmount();
  const method=$('split-method').value, ids=getActiveIds();
  const errEl=$('form-error'); hideErr(errEl);

  if(!title){ showErr(errEl,'è«‹è¼¸å…¥é …ç›®åç¨±'); return; }
  if(!amount||amount<=0){ showErr(errEl,'é‡‘é¡å¿…é ˆå¤§æ–¼ 0'); return; }
  if(currency!=='TWD' && (!originalAmount||originalAmount<=0)){ showErr(errEl,'è«‹è¼¸å…¥åŸå§‹é‡‘é¡'); return; }
  if(currency!=='TWD' && (!rate||rate<=0)){ showErr(errEl,'è«‹è¼¸å…¥åŒ¯ç‡'); return; }
  if(!ids.length){ showErr(errEl,'è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡'); return; }

  // Payers
  let payers;
  if(isMultiPayer){
    const payerInps=Array.from(document.querySelectorAll('#payer-inputs input[data-pid]'));
    payers=payerInps.map(i=>({personId:i.dataset.pid,amount:Math.round((parseFloat(i.value)||0)*100)/100})).filter(p=>p.amount>0);
    if(!payers.length){ showErr(errEl,'è«‹è¼¸å…¥è‡³å°‘ä¸€ä½ä»˜æ¬¾äººé‡‘é¡'); return; }
    const paySum=payers.reduce((a,p)=>a+p.amount,0);
    if(Math.abs(paySum-amount)>0.01){ showErr(errEl,`ä»˜æ¬¾åˆè¨ˆ $${fmt(paySum)} èˆ‡ç¸½é¡ $${fmt(amount)} TWD ä¸ç¬¦`); return; }
  } else {
    payers=[{ personId:$('exp-payer').value, amount }];
  }

  // Splits
  let splits=[];
  if(method==='equal'){
    const each=Math.floor((amount/ids.length)*100)/100;
    const last=Math.round((amount-each*(ids.length-1))*100)/100;
    splits=ids.map((pid,i)=>({personId:pid,amount:i===ids.length-1?last:each}));
  } else if(method==='custom'){
    const inps=Array.from(document.querySelectorAll('#custom-inputs input[data-pid]'));
    let sum=0;
    for(const inp of inps){
      const v=parseFloat(inp.value)||0;
      if(v<0){ showErr(errEl,'åˆ†æ”¤é‡‘é¡ä¸å¯ç‚ºè² æ•¸'); return; }
      sum+=v; splits.push({personId:inp.dataset.pid,amount:Math.round(v*100)/100});
    }
    if(Math.abs(sum-amount)>0.01){ showErr(errEl,`è‡ªè¨‚é‡‘é¡åˆè¨ˆ $${fmt(sum)} èˆ‡ç¸½é¡ $${fmt(amount)} TWD ä¸ç¬¦`); return; }
  } else {
    const inps=Array.from(document.querySelectorAll('#custom-inputs input[data-pid]'));
    let pctSum=0;
    const pcts=inps.map(inp=>{ const v=parseFloat(inp.value)||0; pctSum+=v; return{pid:inp.dataset.pid,pct:v}; });
    if(Math.abs(pctSum-100)>0.1){ showErr(errEl,`æ¯”ä¾‹åˆè¨ˆ ${pctSum.toFixed(1)}%ï¼Œéœ€ç­‰æ–¼ 100%`); return; }
    let assigned=0;
    splits=pcts.map((item,i)=>{
      let amt=i===pcts.length-1?Math.round((amount-assigned)*100)/100:Math.round((amount*item.pct/100)*100)/100;
      if(i<pcts.length-1) assigned+=amt;
      return{personId:item.pid,amount:amt};
    });
  }

  const btn=$('submit-btn'); btn.disabled=true; btn.textContent='å„²å­˜ä¸­â€¦'; setSyncStatus('saving');
  try{
    const expData={
      title, total:amount, payers, splits,
      splitMethod:method, createdAt:serverTimestamp(),
      // FX fields
      currency,
      ...(currency!=='TWD' ? { originalAmount, exchangeRate:rate } : {})
    };
    await addDoc(collection(db,'groups',groupId,'expenses'),expData);
    // Reset form
    $('exp-title').value=''; $('exp-original-amount').value=''; $('exp-amount').value=''; $('exp-amount-twd').value='';
    $('exp-currency').value='TWD'; onCurrencyChange();
    $('split-method').value='equal'; $('custom-amounts').style.display='none';
    $('custom-inputs').innerHTML=''; $('custom-hint').textContent='';
    if(isMultiPayer){ document.querySelectorAll('#payer-inputs input').forEach(i=>i.value=''); $('payer-hint').textContent=''; }
    hideErr(errEl); selectAllSplitters();
  }catch(e){ showErr(errEl,'å„²å­˜å¤±æ•—ï¼š'+e.message); setSyncStatus('error'); }
  finally{ btn.disabled=false; btn.textContent='è¨˜éŒ„æ”¯å‡º'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER EXPENSE LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExpenseList(){
  const container=$('expense-list'), countEl=$('expense-count');
  const activeCount=expenses.filter(e=>!e.cleared).length;
  countEl.textContent=expenses.length?`å…± ${expenses.length} ç­†ï¼Œæœªçµæ¸… ${activeCount} ç­†`:'';
  if(!expenses.length){ container.innerHTML=`<div class="empty-state"><div class="icon">ğŸ§¾</div>å°šç„¡æ”¯å‡ºè¨˜éŒ„</div>`; return; }
  container.innerHTML='';

  expenses.slice().reverse().forEach(exp=>{
    const payers  = getPayers(exp);
    const mLabel  = METHOD_LABELS[exp.splitMethod]||exp.splitMethod;
    const splits  = exp.splits||[];
    const isCleared = !!exp.cleared;
    const isFX    = exp.currency && exp.currency!=='TWD';
    const sym     = CURRENCY_SYMBOLS[exp.currency||'TWD']||'$';

    // Payer display string
    const payerNames = payers.map(p=>{
      const person=persons.find(x=>x.id===p.personId);
      return person ? person.name : '?';
    });
    const payerStr = payers.length===1
      ? payerNames[0]+' ä»˜æ¬¾'
      : payerNames.join('ã€')+' å…±åŒä»˜æ¬¾';

    const item=document.createElement('div');
    item.className='expense-item'+(isCleared?' is-cleared':'');

    const summary=document.createElement('div'); summary.className='expense-summary';

    const left=document.createElement('div'); left.style.minWidth='0';
    const titleRow=document.createElement('div'); titleRow.className='expense-title'; titleRow.textContent=exp.title;
    const metaRow=document.createElement('div'); metaRow.className='expense-meta';
    metaRow.innerHTML=`${esc(payerStr)} Â· ${splits.length} äºº <span class="method-badge">${mLabel}</span>`;
    left.appendChild(titleRow); left.appendChild(metaRow);

    const right=document.createElement('div'); right.className='expense-right';

    if(isFX){
      const tag=document.createElement('span'); tag.className='expense-currency-tag';
      tag.textContent=exp.currency;
      right.appendChild(tag);
    }
    if(isCleared){
      const badge=document.createElement('span'); badge.className='cleared-badge'; badge.textContent='âœ“ å·²çµæ¸…';
      right.appendChild(badge);
    }
    const amtSpan=document.createElement('span'); amtSpan.className='expense-amount';
    amtSpan.textContent=`$${fmt(exp.total)} TWD`;
    right.appendChild(amtSpan);

    const clearBtn=document.createElement('button');
    clearBtn.className='btn-clear '+(isCleared?'cleared':'uncleared');
    clearBtn.textContent=isCleared?'å–æ¶ˆçµæ¸…':'æ¨™è¨˜çµæ¸…';
    clearBtn.addEventListener('click',async e=>{
      e.stopPropagation(); setSyncStatus('saving');
      try{ await updateDoc(doc(db,'groups',groupId,'expenses',exp.id),{cleared:!isCleared}); }
      catch(err){ alert('æ›´æ–°å¤±æ•—ï¼š'+err.message); setSyncStatus('error'); }
    });
    right.appendChild(clearBtn);

    const delBtn=document.createElement('button'); delBtn.className='btn-delete'; delBtn.textContent='åˆªé™¤';
    delBtn.addEventListener('click',async e=>{
      e.stopPropagation();
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
      setSyncStatus('saving');
      try{ await deleteDoc(doc(db,'groups',groupId,'expenses',exp.id)); }
      catch(err){ alert('åˆªé™¤å¤±æ•—ï¼š'+err.message); setSyncStatus('error'); }
    });
    right.appendChild(delBtn);

    const expandIcon=document.createElement('span'); expandIcon.className='expand-icon'; expandIcon.textContent='â–¼';
    right.appendChild(expandIcon);
    summary.appendChild(left); summary.appendChild(right);

    // Detail
    const detail=document.createElement('div'); detail.className='expense-detail';
    let detailHTML='';
    // FX conversion note
    if(isFX){
      detailHTML+=`<div class="fx-note">ğŸ’± åŸå§‹é‡‘é¡ï¼š${sym}${fmt(exp.originalAmount)} ${exp.currency} Ã— ${fmtFx(exp.exchangeRate)} = $${fmt(exp.total)} TWD</div>`;
    }
    // Multi-payer breakdown
    if(payers.length>1){
      detailHTML+=`<div style="font-size:12px;color:var(--ink2);margin-bottom:6px;">ä»˜æ¬¾æ˜ç´°</div>`;
      payers.forEach(p=>{
        const person=persons.find(x=>x.id===p.personId);
        detailHTML+=`<div class="split-row"><span>${esc(person?person.name:'?')}</span><span><strong>$${fmt(p.amount)} TWD</strong></span></div>`;
      });
      detailHTML+=`<div style="font-size:12px;color:var(--ink2);margin:8px 0 4px;">åˆ†æ”¤æ˜ç´°ï¼ˆ${mLabel}ï¼‰${isCleared?'<span style="color:var(--green);margin-left:6px;font-weight:600;">ãƒ»å·²çµæ¸…ï¼Œä¸è¨ˆå…¥å¸³</span>':''}</div>`;
    } else {
      detailHTML+=`<div style="font-size:12px;color:var(--ink2);margin-bottom:8px;">åˆ†æ”¤æ˜ç´°ï¼ˆ${mLabel}ï¼‰${isCleared?'<span style="color:var(--green);margin-left:6px;font-weight:600;">ãƒ»å·²çµæ¸…ï¼Œä¸è¨ˆå…¥å¸³</span>':''}</div>`;
    }
    splits.forEach(s=>{
      const person=persons.find(p=>p.id===s.personId);
      const extra=exp.splitMethod==='percent'?` <span style="color:var(--ink2);font-size:11px;">(${(s.amount/exp.total*100).toFixed(1)}%)</span>`:'';
      detailHTML+=`<div class="split-row"><span>${esc(person?person.name:'?')}</span><span><strong>$${fmt(s.amount)} TWD</strong>${extra}</span></div>`;
    });
    detail.innerHTML=detailHTML;

    summary.addEventListener('click',e=>{
      if(e.target.classList.contains('btn-delete')||e.target.classList.contains('btn-clear')) return;
      detail.classList.toggle('open');
      expandIcon.classList.toggle('open',detail.classList.contains('open'));
    });

    item.appendChild(summary); item.appendChild(detail); container.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LEDGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLedger(){
  const pid=$('ledger-person').value, person=persons.find(p=>p.id===pid);
  if(!person) return;
  let totalPaid=0, totalSplit=0;
  const activeRows=[], clearedRows=[];

  expenses.forEach(exp=>{
    const payers  = getPayers(exp);
    const myPay   = payers.find(p=>p.personId===pid);
    const myShare = (exp.splits||[]).find(s=>s.personId===pid);
    if(!myPay&&!myShare) return;
    const paid  = myPay  ? myPay.amount  : 0;
    const split = myShare? myShare.amount: 0;
    const allPayerPersons=payers.map(p=>{ const x=persons.find(q=>q.id===p.personId); return x?x.name:'?'; });
    const isFX=exp.currency&&exp.currency!=='TWD';
    const row={exp, paid, split, net:paid-split,
               payerStr: allPayerPersons.join('ã€'), isFX};
    if(exp.cleared){ clearedRows.push(row); }
    else { totalPaid+=paid; totalSplit+=split; activeRows.push(row); }
  });

  const balance=Math.round((totalPaid-totalSplit)*100)/100;
  const sc=balance>0?'positive':balance<0?'negative':'zero';
  const label=balance>0?'æ‡‰æ”¶æ¬¾':balance<0?'æ‡‰ä»˜æ¬¾':'å·²å¹³è¡¡';
  const bc=balance>0?'badge-receive':balance<0?'badge-pay':'badge-ok';

  const renderRow=(r,isCleared)=>{
    const sign=r.net>=0?'+':'';
    const pctNote=(r.exp.splitMethod==='percent'&&r.split>0)?` (${(r.split/r.exp.total*100).toFixed(1)}%)`:'';
    const fxLine=r.isFX?`<div class="ledger-fx-note">ğŸ’± ${CURRENCY_SYMBOLS[r.exp.currency]||''}${fmt(r.exp.originalAmount)} ${r.exp.currency} Ã— ${fmtFx(r.exp.exchangeRate)} = $${fmt(r.exp.total)} TWD</div>`:'';
    return `<div class="ledger-row${isCleared?' is-cleared':''}">
      <div class="ledger-row-left">
        <div class="ledger-row-title">${esc(r.exp.title)}</div>
        <div class="ledger-row-meta">ä»˜æ¬¾ï¼š${esc(r.payerStr)} Â· ${METHOD_LABELS[r.exp.splitMethod]||''}</div>
        ${fxLine}
        ${isCleared?'<div class="ledger-cleared-note">âœ“ å·²çµæ¸…ï¼Œä¸è¨ˆå…¥</div>':''}
      </div>
      <div class="ledger-row-right">
        ${r.paid>0?`<div class="impact-paid">+$${fmt(r.paid)} TWDï¼ˆå·²ä»˜ï¼‰</div>`:''}
        ${r.split>0?`<div class="impact-split">âˆ’$${fmt(r.split)} TWDï¼ˆåˆ†æ”¤ï¼‰${esc(pctNote)}</div>`:''}
        <div class="impact-net">å°è¨ˆ ${sign}$${fmt(r.net)} TWD</div>
      </div>
    </div>`;
  };

  let html=`
    <div class="ledger-stats">
      <div class="stat-box"><div class="stat-label">å·²ä»˜ç¸½é¡</div><div class="stat-value">$${fmt(totalPaid)}</div></div>
      <div class="stat-box"><div class="stat-label">æ‡‰åˆ†æ”¤</div><div class="stat-value">$${fmt(totalSplit)}</div></div>
      <div class="stat-box"><div class="stat-label">å·®é¡ TWD</div><div class="stat-value ${sc}">${balance>=0?'+':''}$${fmt(balance)}</div></div>
    </div>
    <span class="ledger-badge ${bc}">${label}ï¼š$${fmt(Math.abs(balance))} TWD</span>
    <div class="ledger-breakdown"><h4>æœªçµæ¸…æ˜ç´°</h4>`;

  if(!activeRows.length){ html+=`<div style="color:var(--ink2);font-size:13px;padding:8px 0;">æ­¤è§’è‰²å°šç„¡æœªçµæ¸…çš„æ”¯å‡ºç´€éŒ„</div>`; }
  else { activeRows.forEach(r=>{ html+=renderRow(r,false); }); }
  if(clearedRows.length){ html+=`<h4 style="margin-top:16px;">å·²çµæ¸…ï¼ˆä¸è¨ˆå…¥ï¼‰</h4>`; clearedRows.forEach(r=>{ html+=renderRow(r,true); }); }
  html+=`</div>`;
  $('ledger-content').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTLEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcSettlement(){
  const activeExp=expenses.filter(e=>!e.cleared);
  const balances={};
  persons.forEach(p=>balances[p.id]=0);
  activeExp.forEach(exp=>{
    getPayers(exp).forEach(p=>{ if(balances[p.personId]!==undefined) balances[p.personId]+=p.amount; });
    (exp.splits||[]).forEach(s=>{ if(balances[s.personId]!==undefined) balances[s.personId]-=s.amount; });
  });
  const creditors=[], debtors=[];
  persons.forEach(p=>{
    const b=Math.round(balances[p.id]*100)/100;
    if(b>0.01)  creditors.push({id:p.id,name:p.name,amount:b});
    if(b<-0.01) debtors.push({id:p.id,name:p.name,amount:-b});
  });
  creditors.sort((a,b)=>b.amount-a.amount);
  debtors.sort((a,b)=>b.amount-a.amount);
  const txns=[]; let ci=0, di=0;
  while(ci<creditors.length&&di<debtors.length){
    const c=creditors[ci], d=debtors[di];
    const amt=Math.round(Math.min(c.amount,d.amount)*100)/100;
    txns.push({from:d.id,fromName:d.name,to:c.id,toName:c.name,amount:amt});
    c.amount=Math.round((c.amount-amt)*100)/100;
    d.amount=Math.round((d.amount-amt)*100)/100;
    if(c.amount<0.01) ci++;
    if(d.amount<0.01) di++;
  }
  return txns;
}

const settlementId = txn => `${txn.from}_${txn.to}_${Math.round(txn.amount*100)}`;

async function toggleSettled(sid,checked){
  setSyncStatus('saving');
  try{
    if(checked){ await setDoc(doc(db,'groups',groupId,'settled',sid),{done:true,at:serverTimestamp()}); }
    else { await deleteDoc(doc(db,'groups',groupId,'settled',sid)); }
  }catch(e){ alert('å„²å­˜å¤±æ•—ï¼š'+e.message); setSyncStatus('error'); }
}

function renderSettlement(){
  const container=$('settlement-content');
  if(!expenses.length){ container.innerHTML='<div class="settlement-empty">å°šç„¡æ”¯å‡ºè³‡æ–™</div>'; return; }
  const txns=calcSettlement();
  if(!txns.length){ container.innerHTML='<div class="settlement-empty">ğŸ‰ æ‰€æœ‰å¸³ç›®å·²å¹³è¡¡ï¼</div>'; return; }
  const doneCount=txns.filter(t=>settledIds.has(settlementId(t))).length;
  let html='';
  txns.forEach(txn=>{
    const sid=settlementId(txn), done=settledIds.has(sid);
    html+=`<div class="settlement-item">
      <input type="checkbox" class="settlement-checkbox" data-sid="${sid}" ${done?'checked':''}>
      <div class="settlement-text${done?' done':''}">
        <span class="settlement-from">${esc(txn.fromName)}</span>
        <span class="settlement-arrow">â†’</span>
        <span class="settlement-to">${esc(txn.toName)}</span>
      </div>
      <span class="settlement-amount${done?' done':''}">$${fmt(txn.amount)} TWD</span>
    </div>`;
  });
  html+=`<div class="settlement-footer">å…± ${txns.length} ç­†è½‰å¸³ï¼Œå·²å®Œæˆ ${doneCount} ç­†</div>`;
  container.innerHTML=html;
  container.querySelectorAll('.settlement-checkbox').forEach(cb=>{
    cb.addEventListener('change',()=>toggleSettled(cb.dataset.sid,cb.checked));
  });
}
</script>
</body>
</html>
